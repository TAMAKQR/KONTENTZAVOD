# –ù–æ–≤—ã–π Flow –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¢–µ–∫—Å—Ç+–§–æ—Ç–æ –≤–∏–¥–µ–æ

## üîÑ –î–æ (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ
         ‚Üì
–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç —Å—Ü–µ–Ω—ã
         ‚Üì
‚ùå –°–†–ê–ó–£ –ì–ï–ù–ï–†–ò–†–£–ï–¢ –í–ò–î–ï–û (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
         ‚Üì
–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∏–ª–∏ –æ—à–∏–±–∫–∞
```

## üîÑ –ü–æ—Å–ª–µ (–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±) ‚úÖ

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ
         ‚Üì
–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç —Å—Ü–µ–Ω—ã
         ‚Üì
üëÅÔ∏è –ü–û–ö–ê–ó–´–í–ê–ï–¢ –°–¶–ï–ù–£ 1 –î–õ–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
‚îÇ
‚îú‚îÄ ‚úÖ –î–∞–ª–µ–µ ‚Üí –ö —Å—Ü–µ–Ω–µ 2
‚îú‚îÄ ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º—Ç
‚îú‚îÄ üîÑ –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ö —Å—Ü–µ–Ω–µ 1 –∑–∞–Ω–æ–≤–æ
‚îî‚îÄ ‚¨ÖÔ∏è –û—Ç–º–µ–Ω–∞ ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
         ‚Üì
üëÅÔ∏è –ü–û–ö–ê–ó–´–í–ê–ï–¢ –°–¶–ï–ù–£ 2 –î–õ–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
         ‚Üì
üëÅÔ∏è –ü–û–ö–ê–ó–´–í–ê–ï–¢ –°–¶–ï–ù–£ 3 –î–õ–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
         ‚Üì
‚úÖ –í–°–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–´ ‚Üí –ì–ï–ù–ï–†–ò–†–£–ï–¢ –í–ò–î–ï–û
         ‚Üì
–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã

```python
# –ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

üé¨ –°—Ü–µ–Ω–∞ 1 –∏–∑ 3
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìù –ü—Ä–æ–º—Ç:
    –ö—Ä–∞—Å–∏–≤—ã–π –ø–ª—è–∂ —Å –≤–æ–ª–Ω–∞–º–∏ - –ß–∞—Å—Ç—å 1

üì∏ –§–æ—Ç–æ:
    https://i.ibb.co/abc123.jpg...

‚è±Ô∏è  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5 —Å–µ–∫
üé® –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: cinematic
üìê –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 16:9

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[‚úÖ –î–∞–ª–µ–µ]  [‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å]
[üîÑ –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å]  [‚¨ÖÔ∏è –û—Ç–º–µ–Ω–∞]
```

---

## üîÄ –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏

```
–°—Ü–µ–Ω–∞ 1          –°—Ü–µ–Ω–∞ 2          –°—Ü–µ–Ω–∞ 3          –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
  ‚îÇ                ‚îÇ                ‚îÇ                 ‚îÇ
  ‚îú‚îÄ ‚úÖ –î–∞–ª–µ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îú‚îÄ ‚úÖ –î–∞–ª–µ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îú‚îÄ ‚úÖ –î–∞–ª–µ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚ñ∂Ô∏è –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç
  ‚îÇ                ‚îÇ                ‚îÇ
  ‚îú‚îÄ ‚úèÔ∏è –†–µ–¥–∞–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îú‚îÄ ‚úèÔ∏è –†–µ–¥–∞–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îî‚îÄ ‚úèÔ∏è –†–µ–¥–∞–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí (–ø–æ–∫–∞–∑–∞—Ç—å —Å–Ω–æ–≤–∞)
  ‚îÇ                ‚îÇ
  ‚îî‚îÄ üîÑ –†–µ–≥–µ–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí (–≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –°—Ü–µ–Ω–µ 1)


–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –°—Ü–µ–Ω–µ 3 –Ω–∞–∂–∏–º–∞–µ—Ç "üîÑ –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å":
  –°—Ü–µ–Ω–∞ 3 ‚Üí –°—Ü–µ–Ω–∞ 1 (–Ω–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π)
```

---

## üîó –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –§–æ—Ç–æ ‚Üî –°—Ü–µ–Ω–∞ ‚Üî URL

```
–ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û              –°–¶–ï–ù–´                    API –ó–ê–ü–†–û–°
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üì∑ –§–æ—Ç–æ 1 (–ø–ª—è–∂)
  file_id_1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB
                    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚Üí URL_1: https://i.ibb.co/abc...
                           ‚îÇ
                           ‚îî‚îÄ‚îÄ‚Üí –°—Ü–µ–Ω–∞ 1 (–∏–Ω–¥–µ–∫—Å 0)
                                  ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚Üí API: {
                                         "prompt": "...- –ß–∞—Å—Ç—å 1",
                                         "start_image_url": URL_1  ‚úÖ
                                       }

üì∑ –§–æ—Ç–æ 2 (–∑–∞–∫–∞—Ç)
  file_id_2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB
                    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚Üí URL_2: https://i.ibb.co/def...
                           ‚îÇ
                           ‚îî‚îÄ‚îÄ‚Üí –°—Ü–µ–Ω–∞ 2 (–∏–Ω–¥–µ–∫—Å 1)
                                  ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚Üí API: {
                                         "prompt": "...- –ß–∞—Å—Ç—å 2",
                                         "start_image_url": URL_2  ‚úÖ
                                       }

üì∑ –§–æ—Ç–æ 3 (–ø–∞–ª—å–º—ã)
  file_id_3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB
                    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚Üí URL_3: https://i.ibb.co/ghi...
                           ‚îÇ
                           ‚îî‚îÄ‚îÄ‚Üí –°—Ü–µ–Ω–∞ 3 (–∏–Ω–¥–µ–∫—Å 2)
                                  ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚Üí API: {
                                         "prompt": "...- –ß–∞—Å—Ç—å 3",
                                         "start_image_url": URL_3  ‚úÖ
                                       }
```

**–ü—Ä–∞–≤–∏–ª–æ:** `scene_image_urls[i]` = URL —Ñ–æ—Ç–æ –¥–ª—è `scenes[i]`

---

## üíª –ö–æ–¥ –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

```python
async def show_text_photo_scene_for_confirmation(
    message: types.Message,
    state: FSMContext,
    scene_index: int
):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ü–µ–Ω—É #scene_index

    –õ–æ–≥–∏–∫–∞:
    1. –ï—Å–ª–∏ scene_index >= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ü–µ–Ω ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ
    2. –ò–Ω–∞—á–µ ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ü–µ–Ω—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    """
    data = await state.get_data()
    scenes = data.get("scenes", [])
    scene_image_urls = data.get("scene_image_urls", [])

    if scene_index >= len(scenes):
        # ‚úÖ –í—Å–µ —Å—Ü–µ–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã!
        await generate_text_photo_video(message, state)
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã
    scene = scenes[scene_index]
    scene_image_url = scene_image_urls[scene_index]  # ‚Üê –§–æ—Ç–æ –¥–ª—è —ç—Ç–æ–π —Å—Ü–µ–Ω—ã!

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    scene_text = f"""
    üé¨ –°—Ü–µ–Ω–∞ {scene['id']} –∏–∑ {len(scenes)}
    ‚îÄ {40*'‚îÄ'}

    üìù –ü—Ä–æ–º—Ç: {scene['prompt']}
    üì∏ –§–æ—Ç–æ: {scene_image_url}
    ‚è±Ô∏è  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5 —Å–µ–∫
    """

    await message.answer(scene_text, reply_markup=keyboard)
```

---

## üéØ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Callback

### 1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã

```python
@router.callback_query(lambda c: c.data.startswith("text_photo_scene_approve_"))
async def approve_text_photo_scene(callback, state):
    scene_index = int(callback.data.split("_")[-1])

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π
    next_index = scene_index + 1
    await show_text_photo_scene_for_confirmation(
        callback.message,
        state,
        next_index  # ‚Üê –°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞!
    )
```

### 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã

```python
@router.callback_query(lambda c: c.data.startswith("text_photo_scene_edit_"))
async def edit_text_photo_scene(callback, state):
    scene_index = int(callback.data.split("_")[-1])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –∏ –ø—Ä–æ—Å–∏–º –Ω–æ–≤—ã–π –ø—Ä–æ–º—Ç
    await state.update_data(editing_scene_index=scene_index)
    await state.set_state(VideoStates.text_photo_editing_scene)

    await callback.message.answer(
        f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã {scene_index + 1}\n"
        f"–ù–∞–ø–∏—à–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–º—Ç:"
    )
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ü–µ–Ω—ã

```python
@router.message(VideoStates.text_photo_editing_scene)
async def save_edited_text_photo_scene(message, state):
    data = await state.get_data()
    scenes = data.get("scenes", [])
    editing_index = data.get("editing_scene_index")

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–º—Ç
    scenes[editing_index]["prompt"] = (
        f"{message.text} - –ß–∞—Å—Ç—å {editing_index + 1}"
    )

    await state.update_data(scenes=scenes)

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ü–µ–Ω—É –∑–∞–Ω–æ–≤–æ
    await show_text_photo_scene_for_confirmation(
        message,
        state,
        editing_index  # ‚Üê –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É –∂–µ —Å—Ü–µ–Ω—É
    )
```

### 4. –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω

```python
@router.callback_query(lambda c: c.data == "text_photo_scenes_regenerate_all")
async def regenerate_text_photo_scenes(callback, state):
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫ –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω–µ
    await state.update_data(current_scene_index=0)
    await show_text_photo_scene_for_confirmation(
        callback.message,
        state,
        0  # ‚Üê –ù–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π!
    )
```

---

## ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω:          ~5-10 —Å–µ–∫ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3 —Å—Ü–µ–Ω:       ~3-5 –º–∏–Ω—É—Ç (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!)
–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ:       ~1-2 –º–∏–Ω—É—Ç—ã
–°–∫–ª–µ–∏–≤–∞–Ω–∏–µ:             ~1 –º–∏–Ω—É—Ç–∞
–û—Ç–ø—Ä–∞–≤–∫–∞:               ~30 —Å–µ–∫
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                  ~6-9 –º–∏–Ω—É—Ç
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `text_photo_editing_scene`
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `show_text_photo_scene_for_confirmation()`
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `generate_text_photo_video()` (–≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫)
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ü–µ–Ω
- [x] –ò–∑–º–µ–Ω—ë–Ω flow: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ü–µ–Ω ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- [x] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã
- [x] –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞–º–∏
