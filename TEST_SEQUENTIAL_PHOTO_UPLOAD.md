# 🧪 Тестирование поочередной загрузки фото для сцен

## 🎯 Цель тестирования

Убедиться что система корректно запрашивает фото для каждой сцены поочередно и сохраняет их с правильным соответствием.

## ⚡ Предварительные условия

- ✅ Bot запущен
- ✅ Все токены в `.env` работают
- ✅ ImgBB API доступен
- ✅ GPT-4 работает корректно

## 📋 Тест 1: Базовый поток с 2 фото

**Цель**: Проверить что система правильно запрашивает фото для каждой из 2 сцен

### Шаги:

1. Запустить `/start` в Telegram боте
2. Выбрать **📝 Текст+Фото**
3. Выбрать модель **🎬 Kling v2.5**
4. Написать промт:
   ```
   Красивый закат на пляже с переходом в ночь
   ```
5. Загрузить **ПЕРВОЕ фото** (закат)
6. Загрузить **ВТОРОЕ фото** (ночное небо)
7. Написать `/готово`

### Ожидаемый результат:

```
[Система обрабатывает 2 секунды]

📹 Сцена 1 из 2
════════════════════════
📝 Описание:
    [Сценарий первой сцены от GPT-4]

⏱️  Длительность: 5 сек
────────────────────────
📸 Загрузи фото для этой сцены:
(Одно фото, формат JPG/PNG)
```

### Проверка:

- ✅ Сообщение показывает "Сцена 1 из 2"
- ✅ Показан сценарий для Сцены 1
- ✅ Система ждет фото для Сцены 1

### Действие:

- Загрузить первое фото

### Ожидаемый результат:

```
✅ Фото для сцены 1 загружено!

📹 Сцена 2 из 2
════════════════════════
📝 Описание:
    [Сценарий второй сцены от GPT-4]

⏱️  Длительность: 5 сек
────────────────────────
📸 Загрузи фото для этой сцены:
(Одно фото, формат JPG/PNG)
```

### Проверка:

- ✅ Переходит к Сцене 2
- ✅ Показан другой сценарий
- ✅ Просит фото для Сцены 2

### Действие:

- Загрузить второе фото

### Ожидаемый результат:

```
✅ Фото для сцены 2 загружено!

🎬 Сцена 1 из 2
════════════════════════

📝 Промт:
    [Сценарий Сцены 1]

📸 Фото: https://ibb.co/xxxxx

⏱️  Длительность: 5 сек

[✅ Далее]  [✏️ Редактировать]
```

### Проверка:

- ✅ Показывает подтверждение для Сцены 1
- ✅ Можно редактировать или подтвердить
- ✅ Фото отображается (ссылка на ImgBB)

---

## 📋 Тест 2: Редактирование фото после загрузки

**Цель**: Проверить что пользователь может изменить фото после загрузки

### Шаги (продолжение Теста 1):

1. На экране подтверждения Сцены 1 нажать **✏️ Редактировать**

### Ожидаемый результат:

```
✏️ Редактирование сцены 1

Напиши новый промт для этой сцены:
(После промта можешь загрузить новое фото или пропустить)

[Пользователь пишет новый текст]
```

### Действие:

Написать новый промт:

```
Красивый закат с апельсиновыми облаками и парусниками на горизонте
```

### Ожидаемый результат:

```
✅ Промт обновлен!

Хочешь загрузить новое фото для этой сцены?

📸 Загрузить новое фото
✅ Оставить старое фото
⬅️ Отмена
```

### Проверка:

- ✅ Промт обновлен в state
- ✅ Показаны кнопки выбора фото

### Действие:

Нажать **📸 Загрузить новое фото**

### Ожидаемый результат:

```
📸 Загрузи новое фото для сцены 1:
(Одно фото, формат JPG/PNG)

⬅️ Отмена
```

### Действие:

Загрузить ДРУГОЕ фото (новое)

### Ожидаемый результат:

```
✅ Фото для сцены 1 загружено!

🎬 Сцена 1 из 2
════════════════════════

📝 Промт:
    Красивый закат с апельсиновыми облаками...

📸 Фото: https://ibb.co/yyyyy  ← ДРУГОЙ URL (новое фото)!

[✅ Далее]  [✏️ Редактировать]
```

### Проверка:

- ✅ URL фото изменился (новое фото)
- ✅ Промт тоже изменился
- ✅ Оба изменения сохранены

---

## 📋 Тест 3: Отмена редактирования

**Цель**: Проверить что система правильно обрабатывает отмену

### Шаги (продолжение):

1. На экране с кнопками выбора фото нажать **⬅️ Отмена**

### Ожидаемый результат:

```
❌ Отменено
[Возврат в главное меню или к предыдущему экрану]
```

### Проверка:

- ✅ Состояние очищено
- ✅ Все данные сброшены
- ✅ Можно начать заново

---

## 📋 Тест 4: Полный цикл с 3 фото

**Цель**: Проверить что система работает с большим количеством фото

### Шаги:

1. `/start` → **📝 Текст+Фото** → **Kling v2.5**
2. Промт:
   ```
   Закат: день, вечер, ночь с переходом
   ```
3. Загрузить 3 фото (день, вечер, ночь)
4. `/готово`

### Ожидаемый результат:

Система последовательно:

- Показывает Сцена 1 из 3 → Ждет фото
- Показывает Сцена 2 из 3 → Ждет фото
- Показывает Сцена 3 из 3 → Ждет фото
- Показывает подтверждение для всех 3 сцен

### Проверка:

- ✅ Показывает счетчик "X из 3"
- ✅ Каждая сцена имеет разный сценарий
- ✅ После загрузки всех фото переходит к подтверждению
- ✅ Все 3 фото загружены на ImgBB (разные URL)

---

## 📋 Тест 5: Ошибка при загрузке фото

**Цель**: Проверить обработку ошибок

### Шаги:

1. Начать процесс как в Тесте 1
2. Когда система просит фото, загрузить **текстовый файл** вместо фото

### Ожидаемый результат:

```
❌ Отправь фото для этой сцены или напиши /отмена
```

### Проверка:

- ✅ Система не падает
- ✅ Ошибка обработана корректно
- ✅ Ждет нового ввода

### Действие:

Загрузить правильное фото

### Ожидаемый результат:

```
✅ Фото для сцены 1 загружено!
[Переход к следующей сцене]
```

---

## 📋 Тест 6: Пропуск (если реализовано)

**Цель**: Проверить можно ли пропустить загрузку фото

### Шаги:

Если реализована кнопка "⏭️ Пропустить":

1. На экране загрузки нажать **⏭️ Пропустить**

### Ожидаемый результат:

```
⏭️ Пропускаю фото для сцены 1...
[Переход к Сцене 2]
```

### Проверка:

- ✅ `scene_image_urls[0]` остается пустым (None) или дефолтным
- ✅ Система переходит к следующей сцене

---

## 📊 Логирование для проверки

### Проверяемые логи в консоли:

```
🎬 Text+Photo generation: 2 фото, модель kling
⏳ Обработка промта и создание сцен...
✅ GPT создал 2 улучшенных сцен
───────────────────────────────────
📹 Сцена 1 из 2
[Пусто, ждет фото]
───────────────────────────────────
✅ Фото сцены 1 загружено: https://ibb.co/photo1
───────────────────────────────────
📹 Сцена 2 из 2
[Пусто, ждет фото]
───────────────────────────────────
✅ Фото сцены 2 загружено: https://ibb.co/photo2
───────────────────────────────────
✅ Все фото загружены!
🎬 Показываю сцены для подтверждения
```

---

## ✅ Чек-лист всех тестов

### Тест 1: Базовый поток ✅

- [ ] Система показывает "Сцена 1 из 2"
- [ ] Каждая сцена имеет уникальный сценарий
- [ ] Переходит к Сцене 2 после загрузки фото для Сцены 1
- [ ] После всех фото показывает подтверждение

### Тест 2: Редактирование ✅

- [ ] Можно редактировать промт
- [ ] Можно загружать новое фото
- [ ] Оба изменения сохраняются
- [ ] URL меняется при загрузке нового фото

### Тест 3: Отмена ✅

- [ ] Отмена обрабатывается корректно
- [ ] Состояние очищается
- [ ] Можно начать заново

### Тест 4: Большое количество ✅

- [ ] Работает с 3+ фото
- [ ] Счетчик сцен правильный
- [ ] Все фото загружены правильно

### Тест 5: Обработка ошибок ✅

- [ ] Неправильный файл не загружается
- [ ] Система ждет правильного ввода
- [ ] Правильное фото после ошибки загружается

### Тест 6: Пропуск (опционально) ✅

- [ ] Если реализовано, работает корректно

---

## 🐛 Возможные проблемы и решения

| Проблема                         | Симптом                                 | Решение                           |
| -------------------------------- | --------------------------------------- | --------------------------------- |
| **ImgBB не доступен**            | "Ошибка при загрузке фото"              | Проверить IMGBB_API_KEY, интернет |
| **GPT-4 ошибка**                 | Система не создает сцены                | Проверить OPENAI_API_KEY, лимиты  |
| **Состояние не переходит**       | Система зависает на сцене 1             | Проверить state.set_state() вызов |
| **Фото не сохраняется**          | URL пуст в scene_image_urls             | Проверить индекс и размер списка  |
| **Фото загружается неправильно** | Другой URL для каждого фото одной сцены | Проверить что file_id правильный  |

---

## 📝 Результат

Если все тесты пройдены ✅:

- Система полностью работает с поочередной загрузкой фото
- Каждому фото точно соответствует одна сцена
- Редактирование работает корректно
- Обработка ошибок работает как ожидается

Система **готова к использованию в продакшене**! 🚀
