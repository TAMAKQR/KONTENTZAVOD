# 🎯 Визуальное объяснение Photo-to-Scene Mapping

## Простое объяснение (как для новичка)

```
📸 Вы загружаете фото в Telegram:

Шаг 1: Загрузили первое фото (пляж)
       ↓ Система: "✅ Фото 1 загружено!"

Шаг 2: Загрузили второе фото (закат)
       ↓ Система: "✅ Фото 2 загружено!"

Шаг 3: Загрузили третье фото (пальмы)
       ↓ Система: "✅ Фото 3 загружено!"

Шаг 4: Нажали /готово
       ↓ Система начинает генерацию

🎬 Система создаст 3 видео:
       Video 1 = Ваш промт + Фото 1 (пляж)
       Video 2 = Ваш промт + Фото 2 (закат)
       Video 3 = Ваш промт + Фото 3 (пальмы)

       Все 3 видео склеены в одно = финальное видео!
```

---

## Детальная диаграмма потока данных

```
╔════════════════════════════════════════════════════════════════╗
║                  TELEGRAM ПОЛЬЗОВАТЕЛЬ                         ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        📸 Фото 1: пляж.jpg
        📸 Фото 2: закат.jpg
        📸 Фото 3: пальмы.jpg
        "Красивый пляж"
        /готово
                              ↓
╔════════════════════════════════════════════════════════════════╗
║              TELEGRAM BOT (handlers/video_handler.py)          ║
║  process_text_photo_image() → start_text_photo_generation()   ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        photos = [
            file_id_1,  ← Фото 1 (пляж)
            file_id_2,  ← Фото 2 (закат)
            file_id_3   ← Фото 3 (пальмы)
        ]

        prompt = "Красивый пляж"
                              ↓
╔════════════════════════════════════════════════════════════════╗
║           IMAGE UPLOADER (image_utils.py)                      ║
║   ImageUploader.process_telegram_photo()                       ║
║   ├─ Скачивает с Telegram                                      ║
║   └─ Загружает на ImgBB                                        ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        Цикл: for i, file_id in enumerate(photo_file_ids):

        Итерация 1 (i=0):
        ├─ file_id_1 → скачать → загрузить на ImgBB
        ├─ Результат: https://i.ibb.co/abc123.jpg
        └─ Добавить в scene_image_urls[0]

        Итерация 2 (i=1):
        ├─ file_id_2 → скачать → загрузить на ImgBB
        ├─ Результат: https://i.ibb.co/def456.jpg
        └─ Добавить в scene_image_urls[1]

        Итерация 3 (i=2):
        ├─ file_id_3 → скачать → загрузить на ImgBB
        ├─ Результат: https://i.ibb.co/ghi789.jpg
        └─ Добавить в scene_image_urls[2]
                              ↓
        scene_image_urls = [
            "https://i.ibb.co/abc123.jpg",  ← Фото 1 → Сцена 1
            "https://i.ibb.co/def456.jpg",  ← Фото 2 → Сцена 2
            "https://i.ibb.co/ghi789.jpg"   ← Фото 3 → Сцена 3
        ]
                              ↓
╔════════════════════════════════════════════════════════════════╗
║           СОЗДАНИЕ СЦЕН (handlers/video_handler.py)            ║
║   Цикл: for i in range(len(scene_image_urls))                 ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        Итерация 1 (i=0):
        scenes[0] = {
            "id": 1,
            "prompt": "Красивый пляж - Часть 1",
            "duration": 5,
            "aspect_ratio": "16:9"
        }

        Итерация 2 (i=1):
        scenes[1] = {
            "id": 2,
            "prompt": "Красивый пляж - Часть 2",
            "duration": 5,
            "aspect_ratio": "16:9"
        }

        Итерация 3 (i=2):
        scenes[2] = {
            "id": 3,
            "prompt": "Красивый пляж - Часть 3",
            "duration": 5,
            "aspect_ratio": "16:9"
        }
                              ↓
╔════════════════════════════════════════════════════════════════╗
║              ГЕНЕРАЦИЯ ВИДЕО (video_generator.py)              ║
║   generate_multiple_scenes(                                    ║
║       scenes=[s0, s1, s2],                                     ║
║       scene_image_urls=[url0, url1, url2]                      ║
║   )                                                             ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        Цикл: for i, scene in enumerate(scenes):
              scene_image = scene_image_urls[i]

        Параллельная генерация (⚡ asyncio.gather):

        Запрос 1 (i=0):
        ├─ scene = scenes[0]
        ├─ scene_image_url = scene_image_urls[0]  ← URL фото 1!
        ├─ generate_scene(prompt="... Часть 1", start_image_url="https://i.ibb.co/abc123.jpg")
        └─ Replicate API → Video 1

        Запрос 2 (i=1):
        ├─ scene = scenes[1]
        ├─ scene_image_url = scene_image_urls[1]  ← URL фото 2!
        ├─ generate_scene(prompt="... Часть 2", start_image_url="https://i.ibb.co/def456.jpg")
        └─ Replicate API → Video 2

        Запрос 3 (i=2):
        ├─ scene = scenes[2]
        ├─ scene_image_url = scene_image_urls[2]  ← URL фото 3!
        ├─ generate_scene(prompt="... Часть 3", start_image_url="https://i.ibb.co/ghi789.jpg")
        └─ Replicate API → Video 3
                              ↓
╔════════════════════════════════════════════════════════════════╗
║            REPLICATE API (Kling v2.5 Turbo Pro)                ║
║   🤖 Генерирует видео на основе:                               ║
║   - prompt (текстовое описание)                                ║
║   - start_image (загруженное фото)                             ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        Video 1: 5 сек на основе фото пляжа
        Video 2: 5 сек на основе фото заката
        Video 3: 5 сек на основе фото пальм
                              ↓
╔════════════════════════════════════════════════════════════════╗
║           СКАЧИВАНИЕ ВИДЕО (video_stitcher.py)                 ║
║   download_video() - параллельное скачивание                   ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        scene_1.mp4 (5 сек)
        scene_2.mp4 (5 сек)
        scene_3.mp4 (5 сек)
                              ↓
╔════════════════════════════════════════════════════════════════╗
║          СКЛЕИВАНИЕ (video_stitcher.py)                        ║
║   stitch_videos(video_paths)                                   ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        final_video.mp4 = [scene_1.mp4] + [scene_2.mp4] + [scene_3.mp4]
                        = 15 сек видео
                              ↓
╔════════════════════════════════════════════════════════════════╗
║            ОТПРАВКА В TELEGRAM                                 ║
║   message.answer_video(final_video.mp4)                        ║
╚════════════════════════════════════════════════════════════════╝
                              ↓
        ✅ Видео отправлено пользователю!
```

---

## Таблица соответствия: Photo → Scene → API

```
┌────┬──────────────────┬──────────┬─────────────────────────────┬──────────────┐
│ #  │ Загруженное фото │ file_id  │ ImgBB URL                   │ Результат    │
├────┼──────────────────┼──────────┼─────────────────────────────┼──────────────┤
│ 1  │ пляж.jpg         │ file_1   │ https://i.ibb.co/abc123.jpg │ Video 1      │
│    │ (первым)         │          │ ↓                           │ (5 сек)      │
│    │                  │          │ Сцена 1 + это фото          │              │
├────┼──────────────────┼──────────┼─────────────────────────────┼──────────────┤
│ 2  │ закат.jpg        │ file_2   │ https://i.ibb.co/def456.jpg │ Video 2      │
│    │ (вторым)         │          │ ↓                           │ (5 сек)      │
│    │                  │          │ Сцена 2 + это фото          │              │
├────┼──────────────────┼──────────┼─────────────────────────────┼──────────────┤
│ 3  │ пальмы.jpg       │ file_3   │ https://i.ibb.co/ghi789.jpg │ Video 3      │
│    │ (третьим)        │          │ ↓                           │ (5 сек)      │
│    │                  │          │ Сцена 3 + это фото          │              │
└────┴──────────────────┴──────────┴─────────────────────────────┴──────────────┘

Результат: Video1 + Video2 + Video3 = Финальное видео (15 сек)
```

---

## Схема памяти Python

```python
# ============ НАЧАЛО ============

state.data = {
    "photos": [file_id_1, file_id_2, file_id_3],
    "prompt": "Красивый пляж",
    "model": "kwaivgi/kling-v2.5-turbo-pro"
}

# ============ ЭТАП 1: Загрузка на ImgBB ============

scene_image_urls = []  # Пустой список

# Итерация 1
image_url_1 = await uploader.process_telegram_photo(..., file_id_1)
# Результат: "https://i.ibb.co/abc123.jpg"
scene_image_urls.append(image_url_1)
# scene_image_urls = ["https://i.ibb.co/abc123.jpg"]

# Итерация 2
image_url_2 = await uploader.process_telegram_photo(..., file_id_2)
# Результат: "https://i.ibb.co/def456.jpg"
scene_image_urls.append(image_url_2)
# scene_image_urls = [
#     "https://i.ibb.co/abc123.jpg",
#     "https://i.ibb.co/def456.jpg"
# ]

# Итерация 3
image_url_3 = await uploader.process_telegram_photo(..., file_id_3)
# Результат: "https://i.ibb.co/ghi789.jpg"
scene_image_urls.append(image_url_3)
# scene_image_urls = [
#     "https://i.ibb.co/abc123.jpg",
#     "https://i.ibb.co/def456.jpg",
#     "https://i.ibb.co/ghi789.jpg"
# ]

# ============ ЭТАП 2: Создание сцен ============

scenes = []  # Пустой список

# Итерация 1 (i=0)
scenes.append({
    "id": 1,
    "prompt": "Красивый пляж - Часть 1",
    "duration": 5,
    "aspect_ratio": "16:9"
})
# scenes[0] ← индекс 0

# Итерация 2 (i=1)
scenes.append({
    "id": 2,
    "prompt": "Красивый пляж - Часть 2",
    "duration": 5,
    "aspect_ratio": "16:9"
})
# scenes[1] ← индекс 1

# Итерация 3 (i=2)
scenes.append({
    "id": 3,
    "prompt": "Красивый пляж - Часть 3",
    "duration": 5,
    "aspect_ratio": "16:9"
})
# scenes[2] ← индекс 2

# ============ ЭТАП 3: Отправка в генератор ============

# Передаём оба списка вместе:
await generator.generate_multiple_scenes(
    scenes=scenes,                    # 3 элемента (индексы 0, 1, 2)
    scene_image_urls=scene_image_urls # 3 элемента (индексы 0, 1, 2)
)

# ============ ЭТАП 4: Генерация видео ============

# Внутри generate_multiple_scenes:
for i, scene in enumerate(scenes):  # i = 0, 1, 2
    scene_image = scene_image_urls[i]  # Берём i-й элемент списка

    # i=0: scene_image = scene_image_urls[0] = "https://i.ibb.co/abc123.jpg"
    # i=1: scene_image = scene_image_urls[1] = "https://i.ibb.co/def456.jpg"
    # i=2: scene_image = scene_image_urls[2] = "https://i.ibb.co/ghi789.jpg"

    task = generate_scene(
        prompt=scene["prompt"],
        start_image_url=scene_image  # ← Каждой сцене своё фото!
    )

# ============ РЕЗУЛЬТАТ ============

# Video_1 сгенерировано с фото_1 (пляж)
# Video_2 сгенерировано с фото_2 (закат)
# Video_3 сгенерировано с фото_3 (пальмы)
```

---

## Пример с индексами массива

```
Загрузили 3 фото:

Telegram:          File IDs:        ImgBB:                     Сцены:
┌──────────────┐   ┌─────────────┐  ┌─────────────────────┐    ┌────────────────┐
│ Фото 1       │ → │ file_id_1   │ → │ https://i.ibb...abc │ → │ Сцена 1        │
│ пляж.jpg     │   │ (индекс 0)  │  │ (индекс 0)          │   │ + фото пляжа   │
└──────────────┘   └─────────────┘  └─────────────────────┘   └────────────────┘
        ↓
┌──────────────┐   ┌─────────────┐  ┌─────────────────────┐    ┌────────────────┐
│ Фото 2       │ → │ file_id_2   │ → │ https://i.ibb...def │ → │ Сцена 2        │
│ закат.jpg    │   │ (индекс 1)  │  │ (индекс 1)          │   │ + фото заката  │
└──────────────┘   └─────────────┘  └─────────────────────┘   └────────────────┘
        ↓
┌──────────────┐   ┌─────────────┐  ┌─────────────────────┐    ┌────────────────┐
│ Фото 3       │ → │ file_id_3   │ → │ https://i.ibb...ghi │ → │ Сцена 3        │
│ пальмы.jpg   │   │ (индекс 2)  │  │ (индекс 2)          │   │ + фото пальм   │
└──────────────┘   └─────────────┘  └─────────────────────┘   └────────────────┘

🔑 Ключевой момент: ИНДЕКС СОВПАДАЕТ НА ВСЕХ ЭТАПАХ!
   photo_index = file_id_index = imgbb_url_index = scene_index = video_index
```

---

## Быстрый чек-лист

Если вы не уверены, правильно ли будут сопоставлены фото:

```
□ 1. Фото загруженные в порядке 1, 2, 3? → ДА ✅
□ 2. Нажали /готово после загрузки? → ДА ✅
□ 3. Количество фото = количеству сцен? → ДА ✅
   (если 3 фото, будет 3 сцены по 5 сек каждая)

Если все пункты "ДА" → Фото будут сопоставлены правильно! ✅

Если что-то "НЕТ" → Проверьте логи и переустарт генерации!
```

---

## Визуализация параллельной генерации

```
ПОСЛЕДОВАТЕЛЬНО (медленно):
┌─────────────┐
│ Сцена 1 + фото 1 → Video 1 (3 мин)
└─────────────┘
                ↓
            ┌─────────────┐
            │ Сцена 2 + фото 2 → Video 2 (3 мин)
            └─────────────┘
                        ↓
                    ┌─────────────┐
                    │ Сцена 3 + фото 3 → Video 3 (3 мин)
                    └─────────────┘

Всего: 9 минут ❌ МЕДЛЕННО


ПАРАЛЛЕЛЬНО (быстро):
┌─────────────────────────────────────────────────┐
│ Сцена 1 + фото 1 → Video 1 (3 мин)              │
│ Сцена 2 + фото 2 → Video 2 (3 мин) ← одновременно!
│ Сцена 3 + фото 3 → Video 3 (3 мин)              │
└─────────────────────────────────────────────────┘

Всего: 3 минуты ✅ БЫСТРО (в 3 раза!)
```

---

## 🎯 Главный вывод

```
ПОРЯДОК ФИКСИРОВАН И СОВПАДАЕТ:

Фото 1 → Video 1
Фото 2 → Video 2
Фото 3 → Video 3

↓

Вы НЕ можете переставить фото между сценами.
Вы НЕ можете пропустить фото.
Вы НЕ можете загрузить больше фото, чем нужно.

Но Вы МОЖЕТЕ:
✅ Загружать фото в любом порядке (по очереди)
✅ Загружать 1, 2, 3, 5, 10 фото (любое количество)
✅ Каждому фото будет соответствовать одна сцена
✅ Все сцены будут генерироваться параллельно (быстро!)
```
