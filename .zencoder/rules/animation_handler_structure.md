# üé® Animation Handler - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –°–æ—Å—Ç–æ—è–Ω–∏—è

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è **–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω** (Image-to-Video). –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤:

- ‚ùå –ù–ï —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ü–µ–Ω—ã
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –û–î–ù–û –≤–∏–¥–µ–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
/animation ‚Üí –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
    ‚Üì
–í—ã–±–æ—Ä —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω (16:9, 9:16, 1:1)
    ‚Üì
–í—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (5 –∏–ª–∏ 10 —Å–µ–∫)
    ‚Üì
–ó–∞–≥—Ä—É–∂–∞—Ç—å –ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ? (–î–ê/–ù–ï–¢)
    ‚Üì
[–ï–°–õ–ò –î–ê] –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω—ã
    ‚Üì
–í–≤–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞
    ‚Üì
–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç? (–î–ê/–ù–ï–¢)
    ‚Üì
[–ï–°–õ–ò –î–ê] –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞
    ‚Üì
–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ –ò–ò? (–î–ê/–ù–ï–¢)
    ‚Üì
[–ï–°–õ–ò –î–ê] –£–ª—É—á—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GPT/Gemini
    ‚Üì
üé¨ –ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ò–î–ï–û (1 –≤–∏–¥–µ–æ, –±–µ–∑ —Å—Ü–µ–Ω)
    ‚Üì
‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
```

## –°–æ—Å—Ç–æ—è–Ω–∏—è FSM

| –°–æ—Å—Ç–æ—è–Ω–∏–µ                     | –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç                                  | –°–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ                          |
| ----------------------------- | ----------------------------------------------- | -------------------------------------------- |
| `choosing_model`              | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å (Kling, Sora, Veo) | `choosing_aspect_ratio`                      |
| `choosing_aspect_ratio`       | –í—ã–±–æ—Ä 16:9 / 9:16 / 1:1                         | `choosing_duration`                          |
| `choosing_duration`           | –í—ã–±–æ—Ä 5 –∏–ª–∏ 10 —Å–µ–∫                              | `choosing_image_option`                      |
| `choosing_image_option`       | –ó–∞–≥—Ä—É–∂–∞—Ç—å –ª–∏ –∫–∞—Ä—Ç–∏–Ω—É? (–î–ê/–ù–ï–¢)                  | `waiting_for_image` –∏–ª–∏ `waiting_for_prompt` |
| `waiting_for_image`           | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ              | `waiting_for_prompt`                         |
| `waiting_for_prompt`          | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º—Ç               | `waiting_for_negative_prompt`                |
| `waiting_for_negative_prompt` | –í—ã–±–æ—Ä: –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç?            | `choosing_enhance_option`                    |
| `choosing_enhance_option`     | –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ –ò–ò?                        | `generating`                                 |
| `generating`                  | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Replicate API             | ‚ùå –ó–∞–≤–µ—Ä—à–µ–Ω–æ                                 |

## Callback Data –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

### –ú–æ–¥–µ–ª–∏

```
anim_model_kling  ‚Üí kwaivgi/kling-v2.5-turbo-pro
anim_model_sora   ‚Üí openai/sora-2
anim_model_veo    ‚Üí google/veo-3.1-fast
```

### –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω

```
anim_aspect_169  ‚Üí 16:9 (–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ)
anim_aspect_916  ‚Üí 9:16 (–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ)
anim_aspect_11   ‚Üí 1:1 (–ö–≤–∞–¥—Ä–∞—Ç)
```

### –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```
anim_duration_5   ‚Üí 5 —Å–µ–∫
anim_duration_10  ‚Üí 10 —Å–µ–∫
```

### –û–ø—Ü–∏–∏

```
anim_image_yes    ‚Üí –ó–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
anim_image_no     ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
anim_neg_yes      ‚Üí –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç
anim_neg_no       ‚Üí –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç
anim_enhance_yes  ‚Üí –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ –ò–ò
anim_enhance_no   ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º—Ç –∫–∞–∫ –µ—Å—Ç—å
```

## –°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ FSM

```python
{
    "model": "kwaivgi/kling-v2.5-turbo-pro",          # –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
    "model_name": "üé¨ Kling v2.5 Turbo Pro",           # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
    "aspect_ratio": "16:9",                            # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
    "duration": 5,                                     # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫
    "image_id": "file_id_123..." –∏–ª–∏ None,             # Telegram file_id –∫–∞—Ä—Ç–∏–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    "prompt": "–ö—Ä–∞—Å–∏–≤—ã–π –ø–µ–π–∑–∞–∂...",                    # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º—Ç
    "negative_prompt": "—Ä–∞–∑–º—É—Ç–æ–µ, –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ",    # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
}
```

## –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ

- `start_animation()` - –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
- `choose_animation_model()` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
- `choose_aspect_ratio()` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω
- `choose_duration()` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `choose_image_yes()` / `choose_image_no()` - –í—ã–±–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω—ã

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

- `process_animation_image()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `process_animation_prompt()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞
- `process_negative_prompt()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞

### –£–ª—É—á—à–µ–Ω–∏–µ

- `add_negative_prompt()` / `skip_negative_prompt()` - –í—ã–±–æ—Ä –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞
- `enhance_prompt_yes()` / `enhance_prompt_no()` - –í—ã–±–æ—Ä —É–ª—É—á—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ò–ò

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è

- `start_generation()` - –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Replicate API

## TODO: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ (enhance_prompt_yes)

```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4 / Gemini –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
original_prompt = "–ö—Ä–∞—Å–∏–≤—ã–π –ø–µ–π–∑–∞–∂"
enhanced_prompt = await enhance_prompt_with_gpt(original_prompt)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –¥—É—Ö –ø–µ–π–∑–∞–∂ –≥–æ—Ä–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω —Å –ø–æ–∫—Ä—ã—Ç—ã–º–∏ —Å–Ω–µ–≥–æ–º –ø–∏–∫–∞–º–∏..."
```

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Replicate

```python
# –ü–æ–ª—É—á–∏—Ç—å Telegram URL –∫–∞—Ä—Ç–∏–Ω—ã
file = await message.bot.get_file(image_id)
image_url = f"https://api.telegram.org/file/bot{BOT_TOKEN}/{file.file_path}"

# –ü–µ—Ä–µ–¥–∞—Ç—å –≤ Replicate –∫–∞–∫ start_image –ø–∞—Ä–∞–º–µ—Ç—Ä
```

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Replicate API

```python
# –î–ª—è Kling v2.5 Turbo Pro
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: prompt, duration, aspect_ratio, start_image (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), negative_prompt

response = await replicate_client.predictions.create(
    model="kwaivgi/kling-v2.5-turbo-pro",
    input={
        "prompt": enhanced_prompt,
        "duration": 5,
        "aspect_ratio": "16:9",
        "start_image": image_url if image_url else None,
        "negative_prompt": negative_prompt,
    }
)
```

### 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ –≤ Telegram

```python
# –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —Å URL
video_path = await download_video(response.output_url)

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
await callback.message.answer_video(
    video=FSInputFile(video_path),
    caption="üéâ –í–æ—Ç —Ç–≤–æ—è –∞–Ω–∏–º–∞—Ü–∏—è!"
)
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Kling v2.5 Turbo Pro

```json
{
  "model": "kwaivgi/kling-v2.5-turbo-pro",
  "parameters": {
    "prompt": "Text prompt for video generation",
    "duration": [5, 10], // seconds
    "aspect_ratio": ["16:9", "9:16", "1:1"],
    "start_image": "URL to image (optional, for image-to-video)",
    "negative_prompt": "Things you don't want to see"
  }
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏: file_id_123
üé¨ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ: kwaivgi/kling-v2.5-turbo-pro
   üìù –ü—Ä–æ–º—Ç: –ö—Ä–∞—Å–∏–≤—ã–π –ø–µ–π–∑–∞–∂...
   ‚ùå –û—Ç—Ä. –ø—Ä–æ–º—Ç: —Ä–∞–∑–º—É—Ç–æ–µ, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å main.py

**–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (/start):**

```
üìπ –¢–µ–∫—Å—Ç ‚Üí –í–∏–¥–µ–æ
üì∏ –¢–µ–∫—Å—Ç ‚Üí –§–æ—Ç–æ
üé® –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã ‚Üê –ù–û–í–û–ï
üñºÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ
```

**Help (/help):**

```
üé® –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã - –û–∂–∏–≤–∏ –∫–∞—Ä—Ç–∏–Ω—É —Å –ø–æ–º–æ—â—å—é AI (–æ–¥–Ω–æ –≤–∏–¥–µ–æ)
```

---

## –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

| –†–∞–∑–¥–µ–ª—ã              | –í–∏–¥–µ–æ      | –§–æ—Ç–æ           | –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–∏–µ     |
| -------------------- | ---------- | -------------- | ---------------- |
| –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å—Ü–µ–Ω—ã   | ‚úÖ –î–∞ (3+) | ‚úÖ –î–∞ (3+)     | ‚ùå –ù–µ—Ç (1 –≤–∏–¥–µ–æ) |
| –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ | ‚ùå –ù–µ—Ç     | ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ   |
| –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç  | ‚ùå –ù–µ—Ç     | ‚ùå –ù–µ—Ç         | ‚úÖ –ï—Å—Ç—å          |
| –£–ª—É—á—à–µ–Ω–∏–µ –ò–ò         | ‚úÖ –ï—Å—Ç—å    | ‚ùå –ù–µ—Ç         | ‚úÖ –ï—Å—Ç—å          |
| –í—ã—Ö–æ–¥                | –í–∏–¥–µ–æ      | –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏     | –í–∏–¥–µ–æ            |

---

**–°—Ç–∞—Ç—É—Å:** üü° –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–æ—Å—Ç–∞–ª–æ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å TODO –ø—É–Ω–∫—Ç—ã)
**–î–∞—Ç–∞:** 28.10.2025
