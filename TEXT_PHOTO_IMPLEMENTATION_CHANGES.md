# ๐ฏ ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะธะทะผะตะฝะตะฝะธั: ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพะต ะพัะพะฑัะฐะถะตะฝะธะต ััะตะฝ

## ๐ ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ

### โ 1. ะะพะฑะฐะฒะปะตะฝะพ ะฝะพะฒะพะต ัะพััะพัะฝะธะต FSM

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะฐ 36

```python
class VideoStates(StatesGroup):
    # ...
    text_photo_editing_scene = State()  # โ ะะะะะ
```

**ะะฐะทะฝะฐัะตะฝะธะต:** ะฃะฟัะฐะฒะปะตะฝะธะต ัะตะดะฐะบัะธัะพะฒะฐะฝะธะตะผ ะพัะดะตะปัะฝัั ััะตะฝ ะฒ ัะตะถะธะผะต ัะตะบัั+ัะพัะพ

---

### โ 2. ะะทะผะตะฝัะฝ flow ะณะตะฝะตัะฐัะธะธ ะฒ `start_text_photo_generation()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 747-758

**ะัะปะพ:**

```python
# ะกัะฐะทั ะณะตะฝะตัะธััะตั ะฒะธะดะตะพ
await status_msg.edit_text("๐ฌ ะะตะฝะตัะธััั ะฒะธะดะตะพ...")
scene_results = await generator.generate_multiple_scenes(...)
```

**ะกัะฐะปะพ:**

```python
# ะกะพััะฐะฝัะตั ะดะฐะฝะฝัะต ะธ ะฟะพะบะฐะทัะฒะฐะตั ะฟะตัะฒัั ััะตะฝั ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั
await state.update_data(
    scenes=scenes,
    scene_image_urls=scene_image_urls,
    current_scene_index=0,
    model_key=model_key
)

await show_text_photo_scene_for_confirmation(message, state, 0)
return
```

**ะญััะตะบั:** ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะบะฐะถะดัั ััะตะฝั ะฟะตัะตะด ะณะตะฝะตัะฐัะธะตะน

---

### โ 3. ะะพะฒะฐั ััะฝะบัะธั: `show_text_photo_scene_for_confirmation()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 766-815

**ะงัะพ ะดะตะปะฐะตั:**

- ะะพะบะฐะทัะฒะฐะตั ะพะดะฝั ััะตะฝั ั ะฟัะพะผัะพะผ ะธ ัะพัะพ
- ะัะปะธ scene_index >= ะบะพะปะธัะตััะฒะพ ััะตะฝ โ ะทะฐะฟััะบะฐะตั ะณะตะฝะตัะฐัะธั ะฒะธะดะตะพ
- ะัะฒะพะดะธั ะบะฝะพะฟะบะธ ะดะปั ัะฟัะฐะฒะปะตะฝะธั

**ะัะธะผะตั ะฒัะฒะพะดะฐ:**

```
๐ฌ ะกัะตะฝะฐ 1 ะธะท 3
โโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะัะพะผั:
    ะัะฐัะธะฒัะน ะฟะปัะถ - ะงะฐััั 1

๐ธ ะคะพัะพ:
    https://i.ibb.co/abc123.jpg...

โฑ๏ธ  ะะปะธัะตะปัะฝะพััั: 5 ัะตะบ
๐จ ะัะผะพััะตัะฐ: cinematic
๐ ะกะพะพัะฝะพัะตะฝะธะต: 16:9

โโโโโโโโโโโโโโโโโโโโโโโโโโ
[โ ะะฐะปะตะต] [โ๏ธ ะะตะดะฐะบัะธัะพะฒะฐัั]
[๐ ะะตะณะตะฝะตัะธัะพะฒะฐัั] [โฌ๏ธ ะัะผะตะฝะฐ]
```

---

### โ 4. ะะฑัะฐะฑะพััะธะบ ะฟะพะดัะฒะตัะถะดะตะฝะธั: `approve_text_photo_scene()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 818-835

**Callback:** `text_photo_scene_approve_{scene_index}`

**ะะพะณะธะบะฐ:**

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั [โ ะะฐะปะตะต]
         โ
ะฃะฒะตะปะธัะธะฒะฐะตะผ ะธะฝะดะตะบั (next_index = scene_index + 1)
         โ
ะัะปะธ next_index < ะบะพะปะธัะตััะฒะพ ััะตะฝ:
  โโ ะะพะบะฐะทัะฒะฐะตะผ ัะปะตะดััััั ััะตะฝั
ะะฝะฐัะต:
  โโ ะะฐะฟััะบะฐะตะผ generate_text_photo_video()
```

---

### โ 5. ะะฑัะฐะฑะพััะธะบ ัะตะดะฐะบัะธัะพะฒะฐะฝะธั: `edit_text_photo_scene()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 838-856

**Callback:** `text_photo_scene_edit_{scene_index}`

**ะะพะณะธะบะฐ:**

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั [โ๏ธ ะะตะดะฐะบัะธัะพะฒะฐัั]
         โ
ะกะพััะฐะฝัะตะผ editing_scene_index
         โ
ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะพััะพัะฝะธะต: text_photo_editing_scene
         โ
ะัะพัะธะผ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะฒะตััะธ ะฝะพะฒัะน ะฟัะพะผั
```

---

### โ 6. ะกะพััะฐะฝะตะฝะธะต ะพััะตะดะฐะบัะธัะพะฒะฐะฝะฝะพะน ััะตะฝั: `save_edited_text_photo_scene()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 859-874

**ะกะพััะพัะฝะธะต:** `VideoStates.text_photo_editing_scene`

**ะะพะณะธะบะฐ:**

```
ะะพะปัะทะพะฒะฐัะตะปั ะฟะธัะตั ะฝะพะฒัะน ะฟัะพะผั
         โ
ะะฑะฝะพะฒะปัะตะผ: scenes[editing_index]["prompt"] = ะฝะพะฒัะน ัะตะบัั + " - ะงะฐััั {N}"
         โ
ะะพะบะฐะทัะฒะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะฝัั ััะตะฝั ะทะฐะฝะพะฒะพ
         โ
ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ัะฝะพะฒะฐ ะฟะพะดัะฒะตัะดะธัั ะธะปะธ ัะตะดะฐะบัะธัะพะฒะฐัั
```

---

### โ 7. ะะฑัะฐะฑะพััะธะบ ัะตะณะตะฝะตัะธัะพะฒะฐะฝะธั: `regenerate_text_photo_scenes()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 877-884

**Callback:** `text_photo_scenes_regenerate_all`

**ะะพะณะธะบะฐ:**

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั [๐ ะะตะณะตะฝะตัะธัะพะฒะฐัั]
         โ
ะกะฑัะฐััะฒะฐะตะผ current_scene_index = 0
         โ
ะะพะบะฐะทัะฒะฐะตะผ ะฟะตัะฒัั ััะตะฝั ะทะฐะฝะพะฒะพ
```

---

### โ 8. ะะพะฒะฐั ััะฝะบัะธั: `generate_text_photo_video()`

**ะคะฐะนะป:** `handlers/video_handler.py`, ัััะพะบะธ 887-1023

**ะงัะพ ะดะตะปะฐะตั:**

- ะัะทัะฒะฐะตััั ัะพะปัะบะพ ะฟะพัะปะต ะฟะพะดัะฒะตัะถะดะตะฝะธั **ะฒัะตั** ััะตะฝ
- ะะทะฒะปะตะบะฐะตั ะดะฐะฝะฝัะต ะธะท ัะพััะพัะฝะธั
- ะัะทัะฒะฐะตั `generator.generate_multiple_scenes()` ั ะฟะฐัะฐะผะตััะพะผ `scene_image_urls`
- ะกะบะฐัะธะฒะฐะตั, ัะบะปะตะธะฒะฐะตั ะธ ะพัะฟัะฐะฒะปัะตั ะฒะธะดะตะพ

**ะะปััะตะฒะพะต ะพัะปะธัะธะต:**

```python
# ะะฐะถะดะพะน ััะตะฝะต ะฟะตัะตะดะฐัััั ะตั ัะพัะพ!
scene_results = await generator.generate_multiple_scenes(
    scenes=scenes,
    model=model_key,
    scene_image_urls=scene_image_urls  # โ ะะฐััะธะฒ URL, ะณะดะต URL[i] ะดะปั scenes[i]
)
```

---

## ๐ ะะพะปะฝัะน flow ะดะธะฐะณัะฐะผะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  start_text_photo_generation()                              โ
โ  - ะะฐะณััะถะฐะตั ัะพัะพ ะฝะฐ ImgBB                                  โ
โ  - ะกะพะทะดะฐัั ััะตะฝั (ะฟะพ ะพะดะฝะพะน ะฝะฐ ัะพัะพ)                        โ
โ  - ะกะพััะฐะฝัะตั ะฒ state: scenes, scene_image_urls, model_key โ
โ  - ะะะะะ: ะัะทัะฒะฐะตั show_text_photo_scene_for_confirmation  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  show_text_photo_scene_for_confirmation(message, state, i)  โ
โ  - ะะพััะฐัั ััะตะฝั[i] ะธ ัะพัะพ[i] ะธะท ัะพััะพัะฝะธั                โ
โ  - ะะพะบะฐะทัะฒะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ััะตะฝั ั ะบะฝะพะฟะบะฐะผะธ                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะบะฝะพะฟะบั
   โโโโโโดโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
   โ                   โ                โ                โ
   โ                   โ                โ                โ
โ ะะฐะปะตะต         โ๏ธ ะะตะดะฐะบัะธัะพะฒะฐัั  ๐ ะะตะณะตะฝะตัะธัะพะฒะฐัั โฌ๏ธ ะัะผะตะฝะฐ
   โ                   โ                โ                โ
   โโโ approve_       โโโ edit_        โโโ regenerate_  โโโ back_to_menu
      text_photo_        text_photo_       text_photo_
      scene()            scene()           scenes()
   โ                   โ                โ
   โโ next_i < len(s) โโ ะะดัั ะฝะพะฒัะน   โโ current_i = 0
   โ   โโ ะะฐ:            ะฟัะพะผั            โ
   โ   โ  show_scene(i+1)                 โโ ะะพะบะฐะทัะฒะฐะตั
   โ   โโ ะะตั:           โ                โ  ััะตะฝั[0]
   โ      โ              show_scene(i)    โ
   โ  generate_           โ               โ
   โ  text_photo_         โโโโโโโโโโโโโโโโโ
   โ  video()
   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ  generate_text_photo_video()        โ
     โ  - ะะตะฝะตัะธััะตั ะฒัะต ะฒะธะดะตะพ             โ
     โ  - ะกะบะฐัะธะฒะฐะตั ะฒัะต ะฒะธะดะตะพ              โ
     โ  - ะกะบะปะตะธะฒะฐะตั ะฒ ะพะดะฝะพ                 โ
     โ  - ะัะฟัะฐะฒะปัะตั ะฒ Telegram            โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
          ๐ ะะพัะพะฒะพ!
```

---

## ๐ ะขะฐะฑะปะธัะฐ ะธะทะผะตะฝะตะฝะธะน

| ะะพะผะฟะพะฝะตะฝั          | ะะพ     | ะะพัะปะต            | ะะทะผะตะฝะตะฝะธะต                     |
| ------------------ | ------ | ---------------- | ----------------------------- |
| **ะกะพััะพัะฝะธั**      | 7      | **8**            | +1 `text_photo_editing_scene` |
| **ะคัะฝะบัะธะธ**        | 2      | **5**            | +3 ะฝะพะฒัะต ััะฝะบัะธะธ              |
| **Callback'ะธ**     | 1      | **4**            | +3 ะฝะพะฒัั ะพะฑัะฐะฑะพััะธะบะฐ          |
| **ะะตะฝะตัะฐัะธั**      | ะกัะฐะทั  | ะะพ ะฟะพะดัะฒะตัะถะดะตะฝะธั | ะะพัะฐะณะพะฒัะน ะฟัะพัะตัั             |
| **ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต** | โ ะะตั | โ ะะฐ            | ะะพะถะฝะพ ัะตะดะฐะบัะธัะพะฒะฐัั ััะตะฝั     |
| **ะะธะดะธะผะพััั**      | ะกะบัััะพ | โ ะะธะดะฝะพ         | ะะธะดะฝั ัะพัะพ ะดะปั ะบะฐะถะดะพะน ััะตะฝั   |

---

## ๐ ะกะฒัะทั ะผะตะถะดั ะบะพะผะฟะพะฝะตะฝัะฐะผะธ

```
ะะะะะซะ ะ STATE:
โโ scenes: [Scene1, Scene2, Scene3, ...]
โโ scene_image_urls: [URL1, URL2, URL3, ...]
โโ current_scene_index: 0, 1, 2, ...
โโ editing_scene_index: (ะบะพะณะดะฐ ัะตะดะฐะบัะธััะตะผ)
โโ model_key: "kling", "veo", "sora"
โโ prompt: ะธััะพะดะฝัะน ะฟัะพะผั

ะคะฃะะะฆะะ:
โโ show_text_photo_scene_for_confirmation(i)
โ  โโ ะะพะบะฐะทัะฒะฐะตั scenes[i] ั scene_image_urls[i]
โโ approve_text_photo_scene() โ show_scene(i+1)
โโ edit_text_photo_scene() โ text_photo_editing_scene
โโ save_edited_text_photo_scene() โ show_scene(i)
โโ regenerate_text_photo_scenes() โ show_scene(0)
โโ generate_text_photo_video()
   โโ ะัะฟะพะปัะทัะตั ะฒัะต ััะตะฝั ะธ URL'ั ะธะท state
```

---

## ๐ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

```python
try:
    # ะะฐะณััะทะบะฐ ัะพัะพ
    # ะกะพะทะดะฐะฝะธะต ััะตะฝ
    # ะะพะบะฐะท ะฟะตัะฒะพะน ััะตะฝั
except Exception as e:
    logger.error(f"โ ะัะธะฑะบะฐ: {e}")
    await message.answer("โ ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต")
    await state.clear()

# ะัะธ ัะตะดะฐะบัะธัะพะฒะฐะฝะธะธ:
if 0 <= editing_index < len(scenes):
    scenes[editing_index]["prompt"] = message.text + f" - ะงะฐััั {editing_index + 1}"
```

---

## ๐ ะคะฐะนะปั, ะธะทะผะตะฝัะฝะฝัะต

- โ `handlers/video_handler.py` - ะัะฝะพะฒะฝัะต ะธะทะผะตะฝะตะฝะธั
  - ะกััะพะบะธ 36: ะะพะฒะพะต ัะพััะพัะฝะธะต
  - ะกััะพะบะธ 747-758: ะะทะผะตะฝัะฝ flow ะฒ `start_text_photo_generation()`
  - ะกััะพะบะธ 766-815: ะะพะฒะฐั ััะฝะบัะธั `show_text_photo_scene_for_confirmation()`
  - ะกััะพะบะธ 818-835: ะะฑัะฐะฑะพััะธะบ `approve_text_photo_scene()`
  - ะกััะพะบะธ 838-856: ะะฑัะฐะฑะพััะธะบ `edit_text_photo_scene()`
  - ะกััะพะบะธ 859-874: ะะฑัะฐะฑะพััะธะบ `save_edited_text_photo_scene()`
  - ะกััะพะบะธ 877-884: ะะฑัะฐะฑะพััะธะบ `regenerate_text_photo_scenes()`
  - ะกััะพะบะธ 887-1023: ะะพะฒะฐั ััะฝะบัะธั `generate_text_photo_video()`

---

## โจ ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะน ัะตะฐะปะธะทะฐัะธะธ

1. **ะะพะปะฝัะน ะบะพะฝััะพะปั** - ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะบะฐะถะดัั ััะตะฝั ะฟะตัะตะด ะณะตะฝะตัะฐัะธะตะน
2. **ะะพะทะผะพะถะฝะพััั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั** - ะะพะถะฝะพ ะธะทะผะตะฝะธัั ะฟัะพะผั ะดะปั ะพัะดะตะปัะฝะพะน ััะตะฝั
3. **ะัะพะทัะฐัะฝะพััั** - ะะธะดะฝะพ, ะบะฐะบะพะต ัะพัะพ ะธัะฟะพะปัะทัะตััั ะดะปั ะบะฐะถะดะพะน ััะตะฝั
4. **ะะพะฝัะธััะตะฝัะฝะพััั** - ะะฐะบ ะฒ ัะตะถะธะผะต ัะตะบัั-ะฒะธะดะตะพ (ัะตะบัั โ ะฟะพะดัะฒะตัะถะดะตะฝะธะต โ ะณะตะฝะตัะฐัะธั)
5. **ะะธะฑะบะพััั** - ะะพะถะฝะพ ะฟะตัะตััะธัะฐัั ะฒัะต ััะตะฝั ั ะฝะฐัะฐะปะฐ

---

## ๐ ะขะตััะธัะพะฒะฐะฝะธะต

### ะกัะตะฝะฐัะธะน 1: ะะฐะทะพะฒัะน ัะตัั

```
1. ะัะฑัะฐัั "ะขะตะบัั + ะคะพัะพ"
2. ะัะฑัะฐัั ะผะพะดะตะปั
3. ะะฐะฟะธัะฐัั ะฟัะพะผั
4. ะะฐะณััะทะธัั 3 ัะพัะพ
5. ะะธะดะธัั ะกัะตะฝั 1 โ [โ ะะฐะปะตะต]
6. ะะธะดะธัั ะกัะตะฝั 2 โ [โ ะะฐะปะตะต]
7. ะะธะดะธัั ะกัะตะฝั 3 โ [โ ะะฐะปะตะต]
8. ะะตะฝะตัะฐัะธั ะดะพะปะถะฝะฐ ะฝะฐัะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
9. ะะธะดะตะพ ะดะพะปะถะฝะพ ะฑััั ะณะพัะพะฒะพ
```

### ะกัะตะฝะฐัะธะน 2: ะขะตัั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั

```
1. ะัะฑัะฐัั "ะขะตะบัั + ะคะพัะพ"
2. ะัะฑัะฐัั ะผะพะดะตะปั
3. ะะฐะฟะธัะฐัั ะฟัะพะผั
4. ะะฐะณััะทะธัั 2 ัะพัะพ
5. ะะธะดะธัั ะกัะตะฝั 1 โ [โ๏ธ ะะตะดะฐะบัะธัะพะฒะฐัั]
6. ะะฐะฟะธัะฐัั ะฝะพะฒัะน ัะตะบัั
7. ะะธะดะธัั ะพะฑะฝะพะฒะปะตะฝะฝัั ะกัะตะฝั 1 โ [โ ะะฐะปะตะต]
8. ะะธะดะธัั ะกัะตะฝั 2 โ [โ ะะฐะปะตะต]
9. ะะตะฝะตัะฐัะธั ะดะพะปะถะฝะฐ ะฝะฐัะฐัััั
10. ะะธะดะตะพ ะดะพะปะถะฝะพ ะฑััั ะณะพัะพะฒะพ
```

### ะกัะตะฝะฐัะธะน 3: ะขะตัั ัะตะณะตะฝะตัะธัะพะฒะฐะฝะธั

```
1. ะัะฑัะฐัั "ะขะตะบัั + ะคะพัะพ"
2. ะัะฑัะฐัั ะผะพะดะตะปั
3. ะะฐะฟะธัะฐัั ะฟัะพะผั
4. ะะฐะณััะทะธัั 2 ัะพัะพ
5. ะะธะดะธัั ะกัะตะฝั 1 โ [๐ ะะตะณะตะฝะตัะธัะพะฒะฐัั]
6. ะกะฝะพะฒะฐ ะฒะธะดะธัั ะกัะตะฝั 1
7. [โ ะะฐะปะตะต]
8. ะะธะดะธัั ะกัะตะฝั 2 โ [๐ ะะตะณะตะฝะตัะธัะพะฒะฐัั]
9. ะกะฝะพะฒะฐ ะฒะธะดะธัั ะกัะตะฝั 1
10. ะ ัะฐะบ ะดะฐะปะตะต...
```
