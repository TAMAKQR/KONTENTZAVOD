# 🎯 Реализованные изменения: Последовательное отображение сцен

## 📍 Что было сделано

### ✅ 1. Добавлено новое состояние FSM

**Файл:** `handlers/video_handler.py`, строка 36

```python
class VideoStates(StatesGroup):
    # ...
    text_photo_editing_scene = State()  # ← НОВОЕ
```

**Назначение:** Управление редактированием отдельных сцен в режиме текст+фото

---

### ✅ 2. Изменён flow генерации в `start_text_photo_generation()`

**Файл:** `handlers/video_handler.py`, строки 747-758

**Было:**

```python
# Сразу генерирует видео
await status_msg.edit_text("🎬 Генерирую видео...")
scene_results = await generator.generate_multiple_scenes(...)
```

**Стало:**

```python
# Сохраняет данные и показывает первую сцену для подтверждения
await state.update_data(
    scenes=scenes,
    scene_image_urls=scene_image_urls,
    current_scene_index=0,
    model_key=model_key
)

await show_text_photo_scene_for_confirmation(message, state, 0)
return
```

**Эффект:** Пользователь видит каждую сцену перед генерацией

---

### ✅ 3. Новая функция: `show_text_photo_scene_for_confirmation()`

**Файл:** `handlers/video_handler.py`, строки 766-815

**Что делает:**

- Показывает одну сцену с промтом и фото
- Если scene_index >= количество сцен → запускает генерацию видео
- Выводит кнопки для управления

**Пример вывода:**

```
🎬 Сцена 1 из 3
──────────────────────────

📝 Промт:
    Красивый пляж - Часть 1

📸 Фото:
    https://i.ibb.co/abc123.jpg...

⏱️  Длительность: 5 сек
🎨 Атмосфера: cinematic
📐 Соотношение: 16:9

──────────────────────────
[✅ Далее] [✏️ Редактировать]
[🔄 Регенерировать] [⬅️ Отмена]
```

---

### ✅ 4. Обработчик подтверждения: `approve_text_photo_scene()`

**Файл:** `handlers/video_handler.py`, строки 818-835

**Callback:** `text_photo_scene_approve_{scene_index}`

**Логика:**

```
Пользователь нажимает [✅ Далее]
         ↓
Увеличиваем индекс (next_index = scene_index + 1)
         ↓
Если next_index < количество сцен:
  └─ Показываем следующую сцену
Иначе:
  └─ Запускаем generate_text_photo_video()
```

---

### ✅ 5. Обработчик редактирования: `edit_text_photo_scene()`

**Файл:** `handlers/video_handler.py`, строки 838-856

**Callback:** `text_photo_scene_edit_{scene_index}`

**Логика:**

```
Пользователь нажимает [✏️ Редактировать]
         ↓
Сохраняем editing_scene_index
         ↓
Устанавливаем состояние: text_photo_editing_scene
         ↓
Просим пользователя ввести новый промт
```

---

### ✅ 6. Сохранение отредактированной сцены: `save_edited_text_photo_scene()`

**Файл:** `handlers/video_handler.py`, строки 859-874

**Состояние:** `VideoStates.text_photo_editing_scene`

**Логика:**

```
Пользователь пишет новый промт
         ↓
Обновляем: scenes[editing_index]["prompt"] = новый текст + " - Часть {N}"
         ↓
Показываем обновленную сцену заново
         ↓
Пользователь может снова подтвердить или редактировать
```

---

### ✅ 7. Обработчик регенерирования: `regenerate_text_photo_scenes()`

**Файл:** `handlers/video_handler.py`, строки 877-884

**Callback:** `text_photo_scenes_regenerate_all`

**Логика:**

```
Пользователь нажимает [🔄 Регенерировать]
         ↓
Сбрасываем current_scene_index = 0
         ↓
Показываем первую сцену заново
```

---

### ✅ 8. Новая функция: `generate_text_photo_video()`

**Файл:** `handlers/video_handler.py`, строки 887-1023

**Что делает:**

- Вызывается только после подтверждения **всех** сцен
- Извлекает данные из состояния
- Вызывает `generator.generate_multiple_scenes()` с параметром `scene_image_urls`
- Скачивает, склеивает и отправляет видео

**Ключевое отличие:**

```python
# Каждой сцене передаётся её фото!
scene_results = await generator.generate_multiple_scenes(
    scenes=scenes,
    model=model_key,
    scene_image_urls=scene_image_urls  # ← Массив URL, где URL[i] для scenes[i]
)
```

---

## 🔄 Полный flow диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│  start_text_photo_generation()                              │
│  - Загружает фото на ImgBB                                  │
│  - Создаёт сцены (по одной на фото)                        │
│  - Сохраняет в state: scenes, scene_image_urls, model_key │
│  - НОВОЕ: Вызывает show_text_photo_scene_for_confirmation  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  show_text_photo_scene_for_confirmation(message, state, i)  │
│  - Достаёт сцену[i] и фото[i] из состояния                │
│  - Показывает пользователю сцену с кнопками                │
└─────────────────────────────────────────────────────────────┘
        ↓ пользователь нажимает кнопку
   ┌────┴──────────────┬────────────────┬────────────────┐
   │                   │                │                │
   ↓                   ↓                ↓                ↓
✅ Далее         ✏️ Редактировать  🔄 Регенерировать ⬅️ Отмена
   │                   │                │                │
   └─→ approve_       └─→ edit_        └─→ regenerate_  └─→ back_to_menu
      text_photo_        text_photo_       text_photo_
      scene()            scene()           scenes()
   │                   │                │
   ├─ next_i < len(s) └─ Ждёт новый   └─ current_i = 0
   │   ├─ Да:            промт            │
   │   │  show_scene(i+1)                 ├─ Показывает
   │   └─ Нет:           │                │  сцену[0]
   │      ↓              show_scene(i)    │
   │  generate_           │               │
   │  text_photo_         └───────────────┘
   │  video()
   │
   └──────────────────────────────────────────→
              ↓
     ┌─────────────────────────────────────┐
     │  generate_text_photo_video()        │
     │  - Генерирует все видео             │
     │  - Скачивает все видео              │
     │  - Склеивает в одно                 │
     │  - Отправляет в Telegram            │
     └─────────────────────────────────────┘
              ↓
          🎉 Готово!
```

---

## 📊 Таблица изменений

| Компонент          | До     | После            | Изменение                     |
| ------------------ | ------ | ---------------- | ----------------------------- |
| **Состояния**      | 7      | **8**            | +1 `text_photo_editing_scene` |
| **Функции**        | 2      | **5**            | +3 новые функции              |
| **Callback'и**     | 1      | **4**            | +3 новых обработчика          |
| **Генерация**      | Сразу  | По подтверждению | Пошаговый процесс             |
| **Редактирование** | ❌ Нет | ✅ Да            | Можно редактировать сцены     |
| **Видимость**      | Скрыто | ✅ Видно         | Видны фото для каждой сцены   |

---

## 🔗 Связь между компонентами

```
ДАННЫЕ В STATE:
├─ scenes: [Scene1, Scene2, Scene3, ...]
├─ scene_image_urls: [URL1, URL2, URL3, ...]
├─ current_scene_index: 0, 1, 2, ...
├─ editing_scene_index: (когда редактируем)
├─ model_key: "kling", "veo", "sora"
└─ prompt: исходный промт

ФУНКЦИИ:
├─ show_text_photo_scene_for_confirmation(i)
│  └─ Показывает scenes[i] с scene_image_urls[i]
├─ approve_text_photo_scene() → show_scene(i+1)
├─ edit_text_photo_scene() → text_photo_editing_scene
├─ save_edited_text_photo_scene() → show_scene(i)
├─ regenerate_text_photo_scenes() → show_scene(0)
└─ generate_text_photo_video()
   └─ Использует все сцены и URL'ы из state
```

---

## 🐛 Обработка ошибок

```python
try:
    # Загрузка фото
    # Создание сцен
    # Показ первой сцены
except Exception as e:
    logger.error(f"❌ Ошибка: {e}")
    await message.answer("❌ Ошибка при обработке")
    await state.clear()

# При редактировании:
if 0 <= editing_index < len(scenes):
    scenes[editing_index]["prompt"] = message.text + f" - Часть {editing_index + 1}"
```

---

## 📝 Файлы, изменённые

- ✅ `handlers/video_handler.py` - Основные изменения
  - Строки 36: Новое состояние
  - Строки 747-758: Изменён flow в `start_text_photo_generation()`
  - Строки 766-815: Новая функция `show_text_photo_scene_for_confirmation()`
  - Строки 818-835: Обработчик `approve_text_photo_scene()`
  - Строки 838-856: Обработчик `edit_text_photo_scene()`
  - Строки 859-874: Обработчик `save_edited_text_photo_scene()`
  - Строки 877-884: Обработчик `regenerate_text_photo_scenes()`
  - Строки 887-1023: Новая функция `generate_text_photo_video()`

---

## ✨ Преимущества новой реализации

1. **Полный контроль** - Пользователь видит каждую сцену перед генерацией
2. **Возможность редактирования** - Можно изменить промт для отдельной сцены
3. **Прозрачность** - Видно, какое фото используется для каждой сцены
4. **Консистентность** - Как в режиме текст-видео (текст → подтверждение → генерация)
5. **Гибкость** - Можно пересчитать все сцены с начала

---

## 🚀 Тестирование

### Сценарий 1: Базовый тест

```
1. Выбрать "Текст + Фото"
2. Выбрать модель
3. Написать промт
4. Загрузить 3 фото
5. Видить Сцену 1 → [✅ Далее]
6. Видить Сцену 2 → [✅ Далее]
7. Видить Сцену 3 → [✅ Далее]
8. Генерация должна начаться автоматически
9. Видео должно быть готово
```

### Сценарий 2: Тест редактирования

```
1. Выбрать "Текст + Фото"
2. Выбрать модель
3. Написать промт
4. Загрузить 2 фото
5. Видить Сцену 1 → [✏️ Редактировать]
6. Написать новый текст
7. Видить обновленную Сцену 1 → [✅ Далее]
8. Видить Сцену 2 → [✅ Далее]
9. Генерация должна начаться
10. Видео должно быть готово
```

### Сценарий 3: Тест регенерирования

```
1. Выбрать "Текст + Фото"
2. Выбрать модель
3. Написать промт
4. Загрузить 2 фото
5. Видить Сцену 1 → [🔄 Регенерировать]
6. Снова видить Сцену 1
7. [✅ Далее]
8. Видить Сцену 2 → [🔄 Регенерировать]
9. Снова видить Сцену 1
10. И так далее...
```
