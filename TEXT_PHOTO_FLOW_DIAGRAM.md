# 📊 Text+Photo Flow Diagram для Kling v2.5 Turbo Pro

## 🔄 Основной Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ПОЛЬЗОВАТЕЛЬ В TELEGRAM                                        │
│                                                                 │
│  1. /start                                                      │
│     ↓                                                           │
│  2. "📹 Создать видео"                                         │
│     ↓                                                           │
│  3. "📝🖼️ Текст + Фото"                                        │
│     ↓                                                           │
│  4. Выбирает модель (Kling)                                     │
│     ↓                                                           │
│  5. Вводит промт: "путешествие по лесу"                        │
│     ↓                                                           │
│  6. Загружает фотографии:                                       │
│     📷 Фото 1 (гора)                                           │
│     📷 Фото 2 (озеро)                                          │
│     📷 Фото 3 (лес)                                            │
│     ↓                                                           │
│  7. Пишет "/готово"                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  СИСТЕМА ОБРАБАТЫВАЕТ (start_text_photo_generation)            │
│                                                                 │
│  ЭТАП 1: Загрузка фото на облако                               │
│  ────────────────────────────────                               │
│    📷 Фото 1 (file_id)                                         │
│      ↓                                                          │
│    [Скачивание с Telegram]                                     │
│      ↓                                                          │
│    [Загрузка на ImgBB]                                         │
│      ↓                                                          │
│    ✅ https://i.ibb.co/abc123.jpg                              │
│                                                                 │
│    📷 Фото 2 (file_id)                                         │
│      ↓                                                          │
│    [Скачивание с Telegram]                                     │
│      ↓                                                          │
│    [Загрузка на ImgBB]                                         │
│      ↓                                                          │
│    ✅ https://i.ibb.co/def456.jpg                              │
│                                                                 │
│    📷 Фото 3 (file_id)                                         │
│      ↓                                                          │
│    [Скачивание с Telegram]                                     │
│      ↓                                                          │
│    [Загрузка на ImgBB]                                         │
│      ↓                                                          │
│    ✅ https://i.ibb.co/ghi789.jpg                              │
│                                                                 │
│  📊 Результат: 3 публичных URL                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ЭТАП 2: Создание JSON сцен                                    │
│  ──────────────────────────                                     │
│                                                                 │
│  scenes = [                                                     │
│    {                                                            │
│      "id": 1,                                                   │
│      "prompt": "путешествие по лесу - Часть 1",               │
│      "duration": 5,                                            │
│      "aspect_ratio": "16:9"                                    │
│    },                                                           │
│    {                                                            │
│      "id": 2,                                                   │
│      "prompt": "путешествие по лесу - Часть 2",               │
│      "duration": 5,                                            │
│      "aspect_ratio": "16:9"                                    │
│    },                                                           │
│    {                                                            │
│      "id": 3,                                                   │
│      "prompt": "путешествие по лесу - Часть 3",               │
│      "duration": 5,                                            │
│      "aspect_ratio": "16:9"                                    │
│    }                                                            │
│  ]                                                              │
│                                                                 │
│  scene_image_urls = [                                          │
│    "https://i.ibb.co/abc123.jpg",  ← Для сцены 1             │
│    "https://i.ibb.co/def456.jpg",  ← Для сцены 2             │
│    "https://i.ibb.co/ghi789.jpg"   ← Для сцены 3             │
│  ]                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ЭТАП 3: Генерация в Replicate API                             │
│  ──────────────────────────────────                             │
│                                                                 │
│  ⚡ ПАРАЛЛЕЛЬНО (одновременно, не по очереди)                 │
│                                                                 │
│  Сцена 1:                          Сцена 2:          Сцена 3:  │
│  ─────────                         ─────────         ─────────  │
│  prompt: "...1"                    prompt: "...2"    prompt..."3"
│  start_image: https://i.ibb.co/abc prompt: "...2"    prompt:"3"
│  123.jpg ──┐                       start_image:      start_image:
│           │                       https://i.ibb.    https://i.ibb
│           ↓                       co/def456.jpg     co/ghi789.jpg
│           Replicate API            ↓                ↓
│           (2-3 минуты)    →  Replicate API    →  Replicate API
│           ↓               (2-3 минуты)        (2-3 минуты)
│           Video URL 1             ↓                ↓
│           (5 сек)         Video URL 2         Video URL 3
│                           (5 сек)             (5 сек)
│                                                     ↓
│  ✅ 3 видео сгенерировано ОДНОВРЕМЕННО (не 9 минут, а 3!)
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ЭТАП 4: Скачивание видео                                      │
│  ────────────────────────                                       │
│                                                                 │
│  ⚡ ПАРАЛЛЕЛЬНО                                                 │
│                                                                 │
│  Video URL 1 → [Скачивание]  ✅ scene_1.mp4                   │
│  Video URL 2 → [Скачивание]  ✅ scene_2.mp4                   │
│  Video URL 3 → [Скачивание]  ✅ scene_3.mp4                   │
│                                                                 │
│  📊 Результат: 3 MP4 файла локально                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ЭТАП 5: Склеивание видео (MoviePy)                            │
│  ─────────────────────────────────                              │
│                                                                 │
│  scene_1.mp4 ┐                                                  │
│  (5 сек)     │                                                  │
│              ├─→ [Склеивание] ──→ final_video.mp4 (15 сек)   │
│  scene_2.mp4 │   [MoviePy]        ✅                           │
│  (5 сек)     ├─→                                                │
│              │                                                  │
│  scene_3.mp4 │                                                  │
│  (5 сек)     │                                                  │
│              ┘                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ЭТАП 6: Отправка в Telegram                                   │
│  ────────────────────────────                                   │
│                                                                 │
│  final_video.mp4 (15 сек, ~50MB)                               │
│      ↓                                                          │
│  [Отправка в Telegram]                                         │
│      ↓                                                          │
│  ✅ ПОЛЬЗОВАТЕЛЬ ПОЛУЧАЕТ ВИДЕО                                 │
│                                                                 │
│  Сообщение:                                                     │
│  "✅ Видео готово!                                             │
│   📝 Промт: путешествие по лесу                               │
│   📸 Фото: 3                                                    │
│   🤖 Модель: KLING                                             │
│   🎬 Сцен: 3"                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎬 Что происходит ВНУТРИ каждой сцены

```
СЦЕНА 1
═══════════════════════════════════════════════════════════

Входные данные:
┌────────────────────────────────────────────────────────┐
│ prompt: "путешествие по лесу - Часть 1"               │
│ duration: 5 (секунд)                                   │
│ aspect_ratio: "16:9" (широкоэкранный)                 │
│ start_image: "https://i.ibb.co/abc123.jpg"            │
│              ↓                                          │
│              (Это ПЕРВОЕ фото, загруженное пользователем)
│                                                        │
│ negative_prompt: "" (по умолчанию пусто)              │
└────────────────────────────────────────────────────────┘

Что делает Kling на Replicate:
┌────────────────────────────────────────────────────────┐
│ 1. Берет фото: https://i.ibb.co/abc123.jpg            │
│    (Это первый фрейм будущего видео)                   │
│                                                        │
│ 2. Читает промт: "путешествие по лесу - Часть 1"     │
│    (Kling понимает что нужно создать)                  │
│                                                        │
│ 3. Генерирует видео от этого фото                      │
│    (5 секунд, как указано в duration)                  │
│                                                        │
│ 4. Сохраняет в MP4 формате 16:9                        │
│                                                        │
│ 5. Выгружает на облако Replicate                       │
└────────────────────────────────────────────────────────┘

Выходные данные:
┌────────────────────────────────────────────────────────┐
│ Video URL: https://replicate.com/output/video1.mp4    │
│ Размер: ~15MB                                          │
│ Длительность: 5 сек                                   │
│ Качество: HD (на стороне Replicate)                    │
└────────────────────────────────────────────────────────┘

СЦЕНА 2
═══════════════════════════════════════════════════════════

Входные данные:
┌────────────────────────────────────────────────────────┐
│ prompt: "путешествие по лесу - Часть 2"               │
│ duration: 5 (секунд)                                   │
│ aspect_ratio: "16:9" (широкоэкранный)                 │
│ start_image: "https://i.ibb.co/def456.jpg"            │
│              ↓                                          │
│              (Это ВТОРОЕ фото, другое!)                │
│                                                        │
│ negative_prompt: "" (по умолчанию пусто)              │
└────────────────────────────────────────────────────────┘

Что делает Kling на Replicate:
┌────────────────────────────────────────────────────────┐
│ 1. Берет фото: https://i.ibb.co/def456.jpg            │
│    (Это ДРУГОЕ фото, не из сцены 1!)                   │
│                                                        │
│ 2. Читает промт: "путешествие по лесу - Часть 2"     │
│    (Продолжение истории)                               │
│                                                        │
│ 3. Генерирует видео от ЭТО фото                        │
│    (5 секунд, независимо от сцены 1)                   │
│                                                        │
│ 4. Сохраняет в MP4 формате 16:9                        │
│                                                        │
│ 5. Выгружает на облако Replicate                       │
└────────────────────────────────────────────────────────┘

Выходные данные:
┌────────────────────────────────────────────────────────┐
│ Video URL: https://replicate.com/output/video2.mp4    │
│ Размер: ~15MB                                          │
│ Длительность: 5 сек                                   │
│ Качество: HD (на стороне Replicate)                    │
└────────────────────────────────────────────────────────┘

СЦЕНА 3
═══════════════════════════════════════════════════════════

Входные данные:
┌────────────────────────────────────────────────────────┐
│ prompt: "путешествие по лесу - Часть 3"               │
│ duration: 5 (секунд)                                   │
│ aspect_ratio: "16:9" (широкоэкранный)                 │
│ start_image: "https://i.ibb.co/ghi789.jpg"            │
│              ↓                                          │
│              (Это ТРЕТЬЕ фото, еще другое!)            │
│                                                        │
│ negative_prompt: "" (по умолчанию пусто)              │
└────────────────────────────────────────────────────────┘

Выходные данные:
┌────────────────────────────────────────────────────────┐
│ Video URL: https://replicate.com/output/video3.mp4    │
│ Размер: ~15MB                                          │
│ Длительность: 5 сек                                   │
│ Качество: HD (на стороне Replicate)                    │
└────────────────────────────────────────────────────────┘

═════════════════════════════════════════════════════════

ИТОГО: 3 видео по 5 сек каждое, ИЗ 3 РАЗНЫХ фото
```

---

## 📝 JSON для Replicate (Детально)

```python
# ЗАПРОС 1 (Сцена 1)
replicate.run(
    "kwaivgi/kling-v2.5-turbo-pro",
    input={
        "prompt": "путешествие по лесу - Часть 1",
        "duration": 5,
        "aspect_ratio": "16:9",
        "start_image": "https://i.ibb.co/abc123.jpg",  # ✅ ФОТО 1
        "negative_prompt": ""
    }
)
# РЕЗУЛЬТАТ: https://replicate.com/output/video1.mp4

# ЗАПРОС 2 (Сцена 2) - ОДНОВРЕМЕННО!
replicate.run(
    "kwaivgi/kling-v2.5-turbo-pro",
    input={
        "prompt": "путешествие по лесу - Часть 2",
        "duration": 5,
        "aspect_ratio": "16:9",
        "start_image": "https://i.ibb.co/def456.jpg",  # ✅ ФОТО 2
        "negative_prompt": ""
    }
)
# РЕЗУЛЬТАТ: https://replicate.com/output/video2.mp4

# ЗАПРОС 3 (Сцена 3) - ОДНОВРЕМЕННО!
replicate.run(
    "kwaivgi/kling-v2.5-turbo-pro",
    input={
        "prompt": "путешествие по лесу - Часть 3",
        "duration": 5,
        "aspect_ratio": "16:9",
        "start_image": "https://i.ibb.co/ghi789.jpg",  # ✅ ФОТО 3
        "negative_prompt": ""
    }
)
# РЕЗУЛЬТАТ: https://replicate.com/output/video3.mp4

# ✅ ВСЕ 3 ЗАПРОСА ОТПРАВЛЯЮТСЯ ОДНОВРЕМЕННО
# ✅ Время ожидания: ~3 минуты (не 9!)
# ✅ Каждая сцена видит РАЗНОЕ фото
```

---

## 🔄 Сравнение ДО и ПОСЛЕ

### ❌ ДО (Было)

```
User uploads 3 photos
       ↓
System passes start_image_url to generate_multiple_scenes()
       ↓
Only FIRST scene gets a photo:

Сцена 1: start_image = https://i.ibb.co/abc123.jpg ✅
Сцена 2: start_image = None ❌ (БЕЗ ФОТО!)
Сцена 3: start_image = None ❌ (БЕЗ ФОТО!)

       ↓
Результат: Только первое видео создается из фото,
           остальные видео генерируются БЕЗ стартовых фотографий!
```

### ✅ ПОСЛЕ (Теперь)

```
User uploads 3 photos
       ↓
System converts to URLs and passes scene_image_urls list
       ↓
EACH scene gets ITS OWN photo:

Сцена 1: start_image = https://i.ibb.co/abc123.jpg ✅
Сцена 2: start_image = https://i.ibb.co/def456.jpg ✅
Сцена 3: start_image = https://i.ibb.co/ghi789.jpg ✅

       ↓
Результат: ВСЕ 3 видео генерируются ИЗ 3 РАЗНЫХ фотографий!
           Плавные переходы между сценами!
```

---

## 📊 Время обработки

```
Timeline:

0:00 - Пользователь отправляет 3 фото и промт
0:00-0:30 - Загрузка 3 фото на Telegram
0:30-1:00 - Загрузка 3 фото на ImgBB (получение URLs)
1:00-1:30 - Создание JSON сцен
1:30-4:30 - Генерация 3 видео ПАРАЛЛЕЛЬНО (не 9 минут!)
4:30-5:00 - Скачивание 3 видео с Replicate
5:00-5:30 - Склеивание видео через MoviePy
5:30-6:00 - Отправка в Telegram
6:00 - ГОТОВО! 🎉

ВСЕГО: ~6-7 минут (или ~12-15 если считать подготовку в боте)
```

---

## 🎯 Ключевые моменты

1. **Каждой сцене СВОЁ фото** ✅

   - Сцена 1 → Фото 1
   - Сцена 2 → Фото 2
   - Сцена 3 → Фото 3

2. **Параллельная генерация** ⚡

   - Все 3 сцены генерируются ОДНОВРЕМЕННО
   - Не 9 минут, а 3 минуты

3. **Публичные URLs на ImgBB** 🌐

   - Replicate требует публичные URLs
   - ImgBB предоставляет CDN доступ

4. **Плавные переходы** 🎬
   - Каждое видео начинается с загруженного фото
   - При склеивании получается единое видео

---

**Версия диаграмм:** 1.0
**Статус:** ✅ Production Ready
**Дата:** 2025
