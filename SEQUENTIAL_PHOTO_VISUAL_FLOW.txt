╔════════════════════════════════════════════════════════════════════════════════╗
║                                                                                ║
║         🎬 НОВЫЙ ПОТОК: ПООЧЕРЕДНАЯ ЗАГРУЗКА ФОТО ДЛЯ КАЖДОЙ СЦЕНЫ           ║
║                                                                                ║
║                         Text + Photo Mode v1.0                                ║
║                                                                                ║
╚════════════════════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────────────────┐
│                              1️⃣  НАЧАЛО                                      │
└──────────────────────────────────────────────────────────────────────────────┘

     👤 ПОЛЬЗОВАТЕЛЬ                    🤖 СИСТЕМА                    ☁️ ОБЛАКО
     ───────────────────                ──────────────                ─────────
            │                                  │                          │
            │  /start                          │                          │
            ├─────────────────────────────────>│                          │
            │                                  │ Выбирает 📝Текст+Фото    │
            │  Выбирает 📝Текст+Фото         │                          │
            │                                  │ Выбирает модель          │
            │  Выбирает модель (Kling)        │                          │
            │                                  │ Ждет промт               │
            │  Пишет промт                    │                          │
            │  "Красивый закат в 3 этапа"    │                          │
            │                                  │ Ждет фото                │
            │  Загружает ФОТО 1 (закат днем)  │                          │
            │  Загружает ФОТО 2 (закат вечер) │                          │
            │  Загружает ФОТО 3 (ночное небо) │                          │
            │                                  │ Ждет команды             │
            │  Пишет /готово                  │                          │
            │                                  │                          │


┌──────────────────────────────────────────────────────────────────────────────┐
│                      2️⃣  ОБРАБОТКА ПРОМТА И СОЗДАНИЕ СЦЕН                   │
└──────────────────────────────────────────────────────────────────────────────┘

            [/готово получено]
                    │
                    ↓
            ┌──────────────────────────────────────┐
            │ start_text_photo_scene_generation()  │
            └──────────────────────────────────────┘
                    │
        ┌───────────┼───────────┬──────────────┐
        ↓           ↓           ↓              ↓
    [обработка]  [GPT-4]  [создание]  [инициализация]
                           сцен        scene_image_urls
        │           │           │              │
        └───────────┴───────────┴──────────────┘
                    │
                    ↓
        ┌──────────────────────────────────────┐
        │ Сцены созданы:                       │
        │ [                                    │
        │   Scene1: "Закат днем...",          │
        │   Scene2: "Закат вечером...",       │
        │   Scene3: "Звёздная ночь..."        │
        │ ]                                    │
        └──────────────────────────────────────┘
                    │
                    ↓
        ┌──────────────────────────────────────┐
        │ scene_image_urls = [None, None, None]│
        │ (пусто, будет заполняться)           │
        └──────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────┐
│          3️⃣  ПООЧЕРЕДНАЯ ЗАГРУЗКА ФОТО (ЦИКЛ ДЛЯ КАЖДОЙ СЦЕНЫ)              │
└──────────────────────────────────────────────────────────────────────────────┘

        ┌─────────────────────────────────────────────────────────┐
        │              ИТЕРАЦИЯ 1: СЦЕНА 1 ИЗ 3                 │
        └─────────────────────────────────────────────────────────┘

     👤 ПОЛЬЗОВАТЕЛЬ                    🤖 СИСТЕМА                    ☁️ ОБЛАКО
     ───────────────────                ──────────────                ─────────
            │                                  │                          │
            │                                  │ show_text_photo_scene_   │
            │                                  │ for_photo_upload(0)      │
            │                                  │                          │
            │   📹 Сцена 1 из 3                │                          │
            │   ════════════════               │                          │
            │   📝 Описание:                   │                          │
            │   "Закат днем, небо окрашено"   │                          │
            │   "в оранжевые тона..."          │                          │
            │   ⏱️ Длительность: 5 сек        │                          │
            │   ────────────────               │                          │
            │   📸 Загрузи фото для Сцены 1   │                          │
            │   (Одно фото, JPG/PNG)          │                          │
            │<──────────────────────────────────│                          │
            │                                  │ State: text_photo_        │
            │                                  │ confirming_scene_photo    │
            │ Загружает фото 1 (закат.jpg)    │                          │
            │────────────────────────────────>│ process_text_photo_       │
            │                                  │ scene_photo()             │
            │                                  │                          │
            │                                  │ ImageUploader.process()  │
            │                                  │────────────────────────>│
            │                                  │                          │ Загруженно
            │                                  │                          │ на ImgBB
            │                                  │<────────────────────────│
            │                                  │ URL: https://ibb.co/1   │
            │                                  │                          │
            │                                  │ scene_image_urls[0] =    │
            │                                  │ "https://ibb.co/1"      │
            │                                  │                          │
            │   ✅ Фото для сцены 1 загр.    │                          │
            │<──────────────────────────────────│                          │
            │                                  │                          │


        ┌─────────────────────────────────────────────────────────┐
        │              ИТЕРАЦИЯ 2: СЦЕНА 2 ИЗ 3                 │
        └─────────────────────────────────────────────────────────┘

            │                                  │ show_text_photo_scene_   │
            │                                  │ for_photo_upload(1)      │
            │                                  │                          │
            │   📹 Сцена 2 из 3                │                          │
            │   ════════════════               │                          │
            │   📝 Описание:                   │                          │
            │   "Закат становится более..."    │                          │
            │   "интенсивным, красные и..."    │                          │
            │   "фиолетовые тона..."           │                          │
            │   ⏱️ Длительность: 5 сек        │                          │
            │   ────────────────               │                          │
            │   📸 Загрузи фото для Сцены 2   │                          │
            │<──────────────────────────────────│                          │
            │                                  │ State: text_photo_        │
            │                                  │ confirming_scene_photo    │
            │ Загружает фото 2 (вечер.jpg)    │                          │
            │────────────────────────────────>│ process_text_photo_       │
            │                                  │ scene_photo()             │
            │                                  │                          │
            │                                  │ ImageUploader.process()  │
            │                                  │────────────────────────>│
            │                                  │                          │ Загруженно
            │                                  │                          │ на ImgBB
            │                                  │<────────────────────────│
            │                                  │ URL: https://ibb.co/2   │
            │                                  │                          │
            │                                  │ scene_image_urls[1] =    │
            │                                  │ "https://ibb.co/2"      │
            │                                  │                          │
            │   ✅ Фото для сцены 2 загр.    │                          │
            │<──────────────────────────────────│                          │
            │                                  │                          │


        ┌─────────────────────────────────────────────────────────┐
        │              ИТЕРАЦИЯ 3: СЦЕНА 3 ИЗ 3                 │
        └─────────────────────────────────────────────────────────┘

            │                                  │ show_text_photo_scene_   │
            │                                  │ for_photo_upload(2)      │
            │                                  │                          │
            │   📹 Сцена 3 из 3                │                          │
            │   ════════════════               │                          │
            │   📝 Описание:                   │                          │
            │   "Звёздная ночь, небо..."       │                          │
            │   "переполнено звёздами..."      │                          │
            │   ⏱️ Длительность: 5 сек        │                          │
            │   ────────────────               │                          │
            │   📸 Загрузи фото для Сцены 3   │                          │
            │<──────────────────────────────────│                          │
            │                                  │ State: text_photo_        │
            │                                  │ confirming_scene_photo    │
            │ Загружает фото 3 (ночь.jpg)     │                          │
            │────────────────────────────────>│ process_text_photo_       │
            │                                  │ scene_photo()             │
            │                                  │                          │
            │                                  │ ImageUploader.process()  │
            │                                  │────────────────────────>│
            │                                  │                          │ Загруженно
            │                                  │                          │ на ImgBB
            │                                  │<────────────────────────│
            │                                  │ URL: https://ibb.co/3   │
            │                                  │                          │
            │                                  │ scene_image_urls[2] =    │
            │                                  │ "https://ibb.co/3"      │
            │                                  │                          │
            │   ✅ Фото для сцены 3 загр.    │                          │
            │<──────────────────────────────────│                          │
            │                                  │                          │


┌──────────────────────────────────────────────────────────────────────────────┐
│                 4️⃣  ВСЕ ФОТО ЗАГРУЖЕНЫ - ПОКАЗ ДЛЯ ПОДТВЕРЖДЕНИЯ            │
└──────────────────────────────────────────────────────────────────────────────┘

            │ current_scene_index == 3    │                          │
            │ (больше нет сцен)           │                          │
            │                             │                          │
            │                             │ State:                   │
            │                             │ text_photo_generating    │
            │                             │                          │
            │                             │ show_text_photo_scene_   │
            │                             │ for_confirmation(0)      │
            │                             │                          │
            │   🎬 Сцена 1 из 3           │                          │
            │   ════════════════          │                          │
            │   📝 Промт:                 │                          │
            │   "Закат днем, небо..."     │                          │
            │   📸 Фото: ✅               │                          │
            │   [Миниатюра фото]          │                          │
            │   ⏱️ Длительность: 5 сек   │                          │
            │   ────────────────          │                          │
            │   [✅ Далее][✏️ Редакт.]   │                          │
            │<──────────────────────────────│                          │
            │                             │                          │
            │ Пользователь может:          │                          │
            │ • Нажать ✅ Далее           │                          │
            │ • Нажать ✏️ Редактировать  │                          │
            │                             │                          │


┌──────────────────────────────────────────────────────────────────────────────┐
│                    5️⃣  РЕДАКТИРОВАНИЕ (ОПЦИОНАЛЬНО)                         │
└──────────────────────────────────────────────────────────────────────────────┘

            │ Нажал ✏️ Редактировать       │                          │
            │────────────────────────────>│ edit_text_photo_scene()  │
            │                             │                          │
            │ ✏️ Редактирование сцены 1   │                          │
            │ ═════════════════════       │                          │
            │ Напиши новый промт:         │                          │
            │                             │                          │
            │ Пишет: "Красивый закат      │                          │
            │ с парусниками на горизонте" │                          │
            │────────────────────────────>│ save_edited_text_photo_  │
            │                             │ scene()                  │
            │                             │                          │
            │ ✅ Промт обновлен!          │                          │
            │ Хочешь загрузить новое фото?│                          │
            │ 📸 Загрузить новое         │                          │
            │ ✅ Оставить старое         │                          │
            │ ⬅️ Отмена                  │                          │
            │<──────────────────────────────│                          │
            │                             │                          │
            │ [Если выбрал "Загрузить"]   │                          │
            │ Загружает НОВОЕ фото        │ edit_scene_upload_photo()│
            │────────────────────────────>│                          │
            │                             │ ImageUploader.process()  │
            │                             │────────────────────────>│
            │                             │                          │ Загруженно
            │                             │<────────────────────────│
            │                             │ URL: https://ibb.co/new │
            │                             │                          │
            │ ✅ Фото обновлено!          │                          │
            │ Возвращаю к подтверждению.  │                          │
            │<──────────────────────────────│                          │


┌──────────────────────────────────────────────────────────────────────────────┐
│                  6️⃣  ПОДТВЕРЖДЕНИЕ ВСЕХ СЦЕН И ГЕНЕРАЦИЯ                   │
└──────────────────────────────────────────────────────────────────────────────┘

            │                             │                          │
            │ [После просмотра всех сцен] │                          │
            │ Нажимает ✅ Далее            │                          │
            │ в последней сцене           │                          │
            │────────────────────────────>│ approve_text_photo_      │
            │                             │ scene()                  │
            │                             │                          │
            │                             │ generate_text_photo_     │
            │                             │ video()                  │
            │                             │                          │
            │ 🎬 Генерирую видео...       │                          │
            │ 📊 Сцен: 3                 │                          │
            │ 🤖 Модель: KLING           │                          │
            │ 📸 Используются загруженные │                          │
            │ фото                        │                          │
            │ ⏳ Примерно 9-15 минут...   │                          │
            │                             │                          │
            │ (ЖДЕТ 3-5 МИНУТ)            │                          │
            │                             │                          │
            │                             │ VideoGenerator.          │
            │                             │ generate_multiple_       │
            │                             │ scenes(                  │
            │                             │   scenes=[...],          │
            │                             │   scene_image_urls=[     │
            │                             │     https://ibb.co/1,   │
            │                             │     https://ibb.co/2,   │
            │                             │     https://ibb.co/3    │
            │                             │   ]                      │
            │                             │ )                        │
            │                             │                          │
            │                             │────────────────────────>│
            │                             │                          │ Replicate
            │                             │                          │ API:
            │                             │                          │ Генерирует
            │                             │                          │ 3 видео
            │                             │<────────────────────────│
            │                             │ scene_1.mp4             │
            │                             │ scene_2.mp4             │
            │                             │ scene_3.mp4             │
            │                             │                          │
            │ ✅ Видео успешно генерировано! │                       │
            │ 📤 Отправляю в Telegram...  │                          │
            │<──────────────────────────────│                          │
            │                             │                          │
            │ 🎬 ФИНАЛЬНОЕ ВИДЕО          │                          │
            │ [Скачивает видео]           │                          │
            │                             │                          │
            │ 🎉 Готово!                  │                          │
            │ final_video.mp4             │                          │
            │                             │                          │


┌──────────────────────────────────────────────────────────────────────────────┐
│                           📊 ИТОГОВАЯ СТАТИСТИКА                             │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ДАННЫЕ В ПАМЯТИ (State)                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ {                                                                           │
│   "scenes": [                                                               │
│     {"id": 1, "prompt": "Закат днем с парусниками...", "duration": 5},     │
│     {"id": 2, "prompt": "Закат вечером, красные тона...", "duration": 5},  │
│     {"id": 3, "prompt": "Звёздная ночь...", "duration": 5}                 │
│   ],                                                                        │
│   "scene_image_urls": [                                                     │
│     "https://ibb.co/image1",    ← Фото для Сцены 1                         │
│     "https://ibb.co/image2",    ← Фото для Сцены 2                         │
│     "https://ibb.co/image3"     ← Фото для Сцены 3                         │
│   ],                                                                        │
│   "model_key": "kling",                                                     │
│   "current_scene_index": 3  ← Все 3 сцены обработаны                       │
│ }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ РЕЗУЛЬТАТЫ ГЕНЕРАЦИИ                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ ✅ Scene 1: https://replicate.com/outputs/video1.mp4                        │
│    • Промт: Закат днем с парусниками...                                     │
│    • Фото: https://ibb.co/image1                                            │
│    • Длительность: 5 сек                                                    │
│                                                                             │
│ ✅ Scene 2: https://replicate.com/outputs/video2.mp4                        │
│    • Промт: Закат вечером, красные тона...                                  │
│    • Фото: https://ibb.co/image2                                            │
│    • Длительность: 5 сек                                                    │
│                                                                             │
│ ✅ Scene 3: https://replicate.com/outputs/video3.mp4                        │
│    • Промт: Звёздная ночь...                                                │
│    • Фото: https://ibb.co/image3                                            │
│    • Длительность: 5 сек                                                    │
│                                                                             │
│ ═════════════════════════════════════════════════════════════════════       │
│ 🎬 ФИНАЛЬНОЕ ВИДЕО: final_video.mp4 (15 сек)                               │
│    • Все 3 сцены склеены вместе                                            │
│    • Качество: 1080p                                                        │
│    • Размер: ~50 MB                                                         │
│    • Отправлено в Telegram ✅                                              │
└─────────────────────────────────────────────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════════╗
║                                                                                ║
║  ✅ ПРОЦЕСС ЗАВЕРШЕН УСПЕШНО                                                 ║
║                                                                                ║
║  Каждому фото соответствует РОВНО одна сцена!                               ║
║  Система полностью под контролем!                                            ║
║  Видео готово! 🎉                                                            ║
║                                                                                ║
╚════════════════════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────────────────┐
│                          📈 СРАВНЕНИЕ: ДО И ПОСЛЕ                           │
└──────────────────────────────────────────────────────────────────────────────┘

БЫЛО ❌                           СТАЛО ✅
─────────────────────────────   ──────────────────────────────
/готово                          /готово
  ↓                                ↓
Загружает ВСЕ фото             Обрабатывает промт через GPT
  ↓                                ↓
Загружает на ImgBB             Создает сцены (по количеству фото)
  ↓                                ↓
❌ "Какое фото для какой        Показывает сцену 1
  сцены?"                          ↓
  ↓                              Просит фото для Сцены 1
Показывает сцены                  ↓
  ↓                              [Пользователь загружает]
Невозможно изменить фото          ↓
  ↓                              Показывает сцену 2
Генерирует видео                  ↓
                                Просит фото для Сцены 2
                                  ↓
                                [Пользователь загружает]
                                  ↓
                                Показывает сцену 3
                                  ↓
                                Просит фото для Сцены 3
                                  ↓
                                [Пользователь загружает]
                                  ↓
                                ✅ Показывает подтверждение
                                ✅ Можно редактировать
                                ✅ Генерирует видео


═══════════════════════════════════════════════════════════════════════════════════

🎯 ОСНОВНАЯ ИДЕЯ:

"Каждому фото - одна сцена, каждой сцене - одно фото"

═══════════════════════════════════════════════════════════════════════════════════