# 🎬 Диаграмма Flow редактирования фото для Text+Photo режима

## 📊 Полная диаграмма состояний

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        РЕЖИМ: TEXT + PHOTO → VIDEO                             │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │ ЭТАП 1: Выбор режима и загрузка фото                                       │ │
│  │                                                                            │ │
│  │  /start → 📹 Текст Видео → 📸 Текст+Фото → Выбор модели → Ввод промта    │ │
│  │                                      │                                    │ │
│  │                                      ↓                                    │ │
│  │                              📸 Загрузка фото                             │ │
│  │                         (одно или несколько фото)                         │ │
│  │                                      │                                    │ │
│  │                                      ↓                                    │ │
│  │                              /готово → Начало обработки                   │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                      ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │ ЭТАП 2: Обработка фото и создание сцен                                    │ │
│  │                                                                            │ │
│  │  📸 Фото загружаются на ImgBB (для каждого фото)                          │ │
│  │        ↓                                                                   │ │
│  │  📝 Промт обрабатывается GPT-4                                            │ │
│  │        ↓                                                                   │ │
│  │  🎬 Создаются сцены (по числу фото)                                       │ │
│  │        ↓                                                                   │ │
│  │  Состояние: text_photo_generating                                         │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                      ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │ ЭТАП 3: Подтверждение и редактирование сцен (НОВОЕ!)                      │ │
│  │                                                                            │ │
│  │  Для каждой сцены:                                                        │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 🎬 Сцена N из M                                                     │ │ │
│  │  │ ─────────────────────                                               │ │ │
│  │  │ 📝 Промт: "описание видео"                                          │ │ │
│  │  │ 📸 Фото: https://ibb.co/xxxxx                                       │ │ │
│  │  │ ⏱️  Длительность: 5 сек                                             │ │ │
│  │  │                                                                     │ │ │
│  │  │ [✅ Далее]  [✏️ Редактировать]                                     │ │ │
│  │  └──────────────────────────────────────────────────────────────────────┘ │ │
│  │                              │                      │                     │ │
│  │                    ┌─────────┘                      └─────────┐           │ │
│  │                    ↓                                          ↓           │ │
│  │          Подтверждение               НОВОЕ: Редактирование  │ │
│  │                    │                          │              │ │
│  │                    ↓                          ↓              │ │
│  │            ✅ Далее нажат        ✏️ Редактирование нажато     │ │
│  │                    │                          │              │ │
│  │                    │              Состояние: text_photo_      │ │
│  │                    │              editing_scene               │ │
│  │                    │                          │              │ │
│  │                    │                          ↓              │ │
│  │                    │              ┌──────────────────────┐   │ │
│  │                    │              │ ✏️ Редактирование   │   │ │
│  │                    │              │                      │   │ │
│  │                    │              │ Напиши новый промт: │   │ │
│  │                    │              │ [                  ]│   │ │
│  │                    │              │                      │   │ │
│  │                    │              │ [⬅️ Отмена]         │   │ │
│  │                    │              └──────────────────────┘   │ │
│  │                    │                          │              │ │
│  │                    │                          ↓              │ │
│  │                    │              Пользователь пишет новый   │ │
│  │                    │              промт                      │ │
│  │                    │                          │              │ │
│  │                    │              Состояние: text_photo_     │ │
│  │                    │              editing_scene_photo        │ │
│  │                    │                          │              │ │
│  │                    │                          ↓              │ │
│  │                    │              ┌──────────────────────┐   │ │
│  │                    │              │ ✅ Промт обновлен! │   │ │
│  │                    │              │                      │   │ │
│  │                    │              │ Хочешь загрузить    │   │ │
│  │                    │              │ новое фото?         │   │ │
│  │                    │              │                      │   │
│  │                    │              │ [📸 Загрузить]      │   │
│  │                    │              │ [✅ Оставить]       │   │
│  │                    │              │ [⬅️ Отмена]         │   │
│  │                    │              └──────────────────────┘   │ │
│  │                    │                    │           │        │ │
│  │                    │          ┌─────────┘           └──────┐ │ │
│  │                    │          ↓                            ↓ │ │
│  │                    │  📸 Загрузить фото    ✅ Оставить фото │ │
│  │                    │          │                            │ │
│  │                    │    waiting_for_scene_photo=true        │ │
│  │                    │          │                            │ │
│  │                    │          ↓                            ↓ │
│  │                    │  ┌────────────────┐         ┌────────────┐ │
│  │                    │  │ 📸 Загрузи    │         │ ✅ Показываем │
│  │                    │  │ новое фото:   │         │ сцену со    │ │
│  │                    │  │               │         │ старым      │ │
│  │                    │  │ (JPG/PNG)     │         │ фото        │ │
│  │                    │  │               │         │             │ │
│  │                    │  │ [⬅️ Отмена]   │         └────────────┘ │
│  │                    │  └────────────────┘         │             │ │
│  │                    │          │                  │             │ │
│  │                    │  Пользователь              │             │ │
│  │                    │  загружает фото            │             │ │
│  │                    │          │                 │             │ │
│  │                    │          ↓                 │             │ │
│  │                    │  ⏳ Загружаю фото          │             │ │
│  │                    │  на облако...              │             │ │
│  │                    │          │                 │             │ │
│  │                    │          ↓                 │             │ │
│  │                    │  🔄 Загрузка на ImgBB      │             │ │
│  │                    │  scene_image_urls[n] =    │             │ │
│  │                    │  "https://ibb.co/yyyyy"   │             │ │
│  │                    │          │                 │             │ │
│  │                    │          ↓                 │             │ │
│  │                    │  ✅ Фото обновлено!       │             │ │
│  │                    │          │                 │             │ │
│  │                    │          └─────────┬───────┘             │ │
│  │                    │                    │                    │ │
│  │                    │                    ↓                    │ │
│  │                    │       ┌──────────────────────────┐       │ │
│  │                    │       │ 🎬 Сцена обновлена       │       │ │
│  │                    │       │ ─────────────────────    │       │ │
│  │                    │       │ 📝 Промт: "новый"       │       │ │
│  │                    │       │ 📸 Фото: [новое фото] │       │ │
│  │                    │       │                          │       │ │
│  │                    │       │ [✅ Далее][✏️ Редакт]    │       │ │
│  │                    │       └──────────────────────────┘       │ │
│  │                    │                    │                    │ │
│  │                    └────────────┬────────┘                    │ │
│  │                                 │                            │ │
│  │                                 ↓                            │ │
│  │                     Переход к следующей сцене               │ │
│  │                     (или генерация видео если                │ │
│  │                     это была последняя сцена)               │ │
│  │                                                              │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                      ↓                             │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ ЭТАП 4: Генерация видео                                      │ │
│  │                                                              │ │
│  │  🎬 Для каждой сцены:                                        │ │
│  │     • Отправляем на Replicate API                           │ │
│  │     • Передаем обновленный промт                            │ │
│  │     • Передаем обновленное фото (scene_image_urls[n])       │ │
│  │                                                              │ │
│  │  ✅ Видео сгенерировано                                      │ │
│  │  📤 Отправлено в Telegram                                    │ │
│  │                                                              │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🎯 Состояния FSM (FSM States)

```
┌─────────────────────────────────┐
│   ВЫБОР РЕЖИМА                  │
│ choosing_type                   │
└─────────────┬───────────────────┘
              │
              ↓
┌─────────────────────────────────┐
│ TEXT + PHOTO РЕЖИМ              │
├─────────────────────────────────┤
│                                 │
│ 1. text_photo_choosing_model    │ → Выбор модели
│                                 │
│ 2. text_photo_waiting_prompt    │ → Ввод промта
│                                 │
│ 3. text_photo_waiting_photo     │ → Загрузка фото
│                                 │
│ 4. text_photo_generating        │ → Подтверждение сцен
│        ├─→ Показываем сцену     │
│        └─→ Ждем подтверждения   │
│                                 │
│    НА ЭТОМ ЭТАПЕ НОВОЕ:         │
│                                 │
│    Если нажимает ✏️ "Редакт.":  │
│    ↓                            │
│    5. text_photo_editing_scene  │ ← NEW
│        └─→ Ввод нового промта   │
│                                 │
│       После ввода промта:       │
│       ↓                         │
│    6. text_photo_editing_scene_ │ ← NEW
│       photo                     │
│        ├─→ Выбор фото           │
│        └─→ Загрузка нового      │
│            фото (если выбрал)   │
│                                 │
│       Затем возврат к:          │
│       ↓                         │
│       4. text_photo_generating  │
│           (с обновленными       │
│            данными)             │
│                                 │
└─────────────────────────────────┘
```

## 📱 Переходы между обработчиками

```
user_input: "✏️ Редактировать"
              ↓
   edit_text_photo_scene()
   └─ set_state(text_photo_editing_scene)
   └─ show menu for editing

user_input: "новый промт"
              ↓
   save_edited_text_photo_scene()
   └─ scenes[i]["prompt"] = new_prompt
   └─ set_state(text_photo_editing_scene_photo)
   └─ show buttons: [📸 Load | ✅ Keep]

user_input: "📸 Load button"
              ↓
   edit_scene_upload_photo()
   └─ waiting_for_scene_photo = True
   └─ show: "Upload new photo"

user_input: "photo file"
              ↓
   save_edited_scene_photo()
   └─ ImageUploader.process_telegram_photo()
   └─ scene_image_urls[i] = new_url
   └─ set_state(text_photo_generating)
   └─ show_text_photo_scene_for_confirmation()

user_input: "✅ Keep button"
              ↓
   keep_old_photo()
   └─ set_state(text_photo_generating)
   └─ show_text_photo_scene_for_confirmation()

user_input: "✅ Далее"
              ↓
   approve_text_photo_scene()
   └─ current_scene_index++
   └─ if more scenes: show next
   └─ else: generate_text_photo_video()
```

## 🔐 Данные во время процесса

```
НАЧАЛО (после /готово):
{
    "prompt": "Красивый закат",
    "model": "kwaivgi/kling-v2.5-turbo-pro",
    "model_key": "kling",
    "scenes": [
        {"id": 1, "prompt": "Сцена 1", "duration": 5, ...},
        {"id": 2, "prompt": "Сцена 2", "duration": 5, ...},
        {"id": 3, "prompt": "Сцена 3", "duration": 5, ...}
    ],
    "scene_image_urls": [
        "https://ibb.co/photo1",
        "https://ibb.co/photo2",
        "https://ibb.co/photo3"
    ],
    "current_scene_index": 0
}

ПОСЛЕ РЕДАКТИРОВАНИЯ СЦЕНЫ 1:
{
    ... (все как выше) ...
    "scenes": [
        {"id": 1, "prompt": "Закат с птицами", ...},  ← ОБНОВЛЕНО
        ...
    ],
    "scene_image_urls": [
        "https://ibb.co/photo_new",  ← ОБНОВЛЕНО (если загружал)
        ...
    ],
    "editing_scene_index": 0,
    "waiting_for_scene_photo": False
}

ПЕРЕД ГЕНЕРАЦИЕЙ:
{
    ... все данные с обновленными промтами и фото ...
}
```

## ✅ Проверки корректности

```
При загрузке фото проверяем:
✓ message.photo exists
✓ scene_index в диапазоне [0, len(scenes))
✓ ImageUploader вернул URL
✓ new_image_url not None
✓ Успешно обновлено scene_image_urls

При переводе состояний:
✓ Правильно устанавливаем waiting_for_scene_photo
✓ Правильно переводим в нужное состояние
✓ Сохраняем нужные данные в state.update_data()

При показывании сцены:
✓ Показываем правильный индекс
✓ Берем правильное фото из scene_image_urls
✓ Показываем обновленный промт
✓ Кнопки редактирования всегда доступны
```

## 🎬 Интеграция с VideoGenerator

```
generate_multiple_scenes(
    scenes=[
        {"prompt": "обновленный промт 1", ...},
        {"prompt": "обновленный промт 2", ...},
        {"prompt": "обновленный промт 3", ...}
    ],
    model="kling",
    scene_image_urls=[
        "https://ibb.co/photo_new_1",  ← НОВОЕ или старое фото
        "https://ibb.co/photo_new_2",
        "https://ibb.co/photo_new_3"
    ]
)
        ↓
    Для каждой сцены[i]:
    • Берет scenes[i]["prompt"]
    • Берет scene_image_urls[i]
    • Отправляет на Replicate API
        ↓
    ✅ Видео с обновленными параметрами
```

Вот такой получился полный flow редактирования фото! 🎉
